

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>smriprep.workflows.surfaces &mdash; smriprep 0.18.1.dev76 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5dd5ad26" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/banner.css?v=fd51b7f5" />

  
      <script src="../../../_static/jquery.js?v=1413ff29"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=7b397ac5"></script>
      <script src="../../../_static/doctools.js?v=6afcdcd2"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            smriprep
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">Library API (application program interface)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changes.html">Whatâ€™s new?</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">smriprep</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">smriprep.workflows.surfaces</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  


    
    



    <p class="scv-banner scv-sphinx_rtd_theme"><b>Warning:</b> This document is for the development version of smriprep.</p>
<h1>Source code for smriprep.workflows.surfaces</h1><div class="highlight"><pre>
<span></span><span class="c1"># emacs: -*- mode: python; py-indent-offset: 4; indent-tabs-mode: nil -*-</span>
<span class="c1"># vi: set ft=python sts=4 ts=4 sw=4 et:</span>
<span class="c1">#</span>
<span class="c1"># Copyright 2021 The NiPreps Developers &lt;nipreps@gmail.com&gt;</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>
<span class="c1"># We support and encourage derived works from this project, please read</span>
<span class="c1"># about our expectations at</span>
<span class="c1">#</span>
<span class="c1">#     https://www.nipreps.org/community/licensing/</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Surface preprocessing workflows.</span>

<span class="sd">**sMRIPrep** uses FreeSurfer to reconstruct surfaces from T1w/T2w</span>
<span class="sd">structural images.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ty</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">nipype.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">freesurfer</span> <span class="k">as</span> <span class="n">fs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nipype.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">io</span> <span class="k">as</span> <span class="n">nio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nipype.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">utility</span> <span class="k">as</span> <span class="n">niu</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nipype.interfaces.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Undefined</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nipype.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">engine</span> <span class="k">as</span> <span class="n">pe</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Workflow</span><span class="p">,</span> <span class="n">tag</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.interfaces.freesurfer</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">FSDetectInputs</span><span class="p">,</span>
    <span class="n">FSInjectBrainExtracted</span><span class="p">,</span>
    <span class="n">RefineBrainMask</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.interfaces.freesurfer</span><span class="w"> </span><span class="kn">import</span> <span class="n">PatchedRobustRegister</span> <span class="k">as</span> <span class="n">RobustRegister</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.interfaces.nitransforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConcatenateXFMs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.interfaces.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">FreeSurferSource</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.interfaces.utility</span><span class="w"> </span><span class="kn">import</span> <span class="n">KeySelect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.interfaces.workbench</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">MetricDilate</span><span class="p">,</span>
    <span class="n">MetricFillHoles</span><span class="p">,</span>
    <span class="n">MetricMask</span><span class="p">,</span>
    <span class="n">MetricRemoveIslands</span><span class="p">,</span>
    <span class="n">MetricResample</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">smriprep</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">smriprep.interfaces.surf</span><span class="w"> </span><span class="kn">import</span> <span class="n">MakeRibbon</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">smriprep.interfaces.workbench</span><span class="w"> </span><span class="kn">import</span> <span class="n">SurfaceResample</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..interfaces.freesurfer</span><span class="w"> </span><span class="kn">import</span> <span class="n">MakeMidthickness</span><span class="p">,</span> <span class="n">ReconAll</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..interfaces.gifti</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetricMath</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..interfaces.workbench</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateSignedDistanceVolume</span>


<div class="viewcode-block" id="init_surface_recon_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.surfaces.html#smriprep.workflows.surfaces.init_surface_recon_wf">[docs]</a>
<span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;anat.recon&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_surface_recon_wf</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">omp_nthreads</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">hires</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">fs_no_resume</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">precomputed</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;surface_recon_wf&#39;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reconstruct anatomical surfaces using FreeSurfer&#39;s ``recon-all``.</span>

<span class="sd">    Reconstruction is performed in three phases.</span>
<span class="sd">    The first phase initializes the subject with T1w and T2w (if available)</span>
<span class="sd">    structural images and performs basic reconstruction (``autorecon1``) with the</span>
<span class="sd">    exception of skull-stripping.</span>
<span class="sd">    For example, a subject with only one session with T1w and T2w images</span>
<span class="sd">    would be processed by the following command::</span>

<span class="sd">        $ recon-all -sd &lt;output dir&gt;/freesurfer -subjid sub-&lt;subject_label&gt; \</span>
<span class="sd">            -i &lt;bids-root&gt;/sub-&lt;subject_label&gt;/anat/sub-&lt;subject_label&gt;_T1w.nii.gz \</span>
<span class="sd">            -T2 &lt;bids-root&gt;/sub-&lt;subject_label&gt;/anat/sub-&lt;subject_label&gt;_T2w.nii.gz \</span>
<span class="sd">            -autorecon1 \</span>
<span class="sd">            -noskullstrip -noT2pial -noFLAIRpial</span>

<span class="sd">    The second phase imports an externally computed skull-stripping mask.</span>
<span class="sd">    This workflow refines the external brainmask using the internal mask</span>
<span class="sd">    implicit the the FreeSurfer&#39;s ``aseg.mgz`` segmentation,</span>
<span class="sd">    to reconcile ANTs&#39; and FreeSurfer&#39;s brain masks.</span>

<span class="sd">    First, the ``aseg.mgz`` mask from FreeSurfer is refined in two</span>
<span class="sd">    steps, using binary morphological operations:</span>

<span class="sd">      1. With a binary closing operation the sulci are included</span>
<span class="sd">         into the mask. This results in a smoother brain mask</span>
<span class="sd">         that does not exclude deep, wide sulci.</span>

<span class="sd">      2. Fill any holes (typically, there could be a hole next to</span>
<span class="sd">         the pineal gland and the corpora quadrigemina if the great</span>
<span class="sd">         cerebral brain is segmented out).</span>

<span class="sd">    Second, the brain mask is grown, including pixels that have a high likelihood</span>
<span class="sd">    to the GM tissue distribution:</span>

<span class="sd">      3. Dilate and subtract the brain mask, defining the region to search for candidate</span>
<span class="sd">         pixels that likely belong to cortical GM.</span>

<span class="sd">      4. Pixels found in the search region that are labeled as GM by ANTs</span>
<span class="sd">         (during ``antsBrainExtraction.sh``) are directly added to the new mask.</span>

<span class="sd">      5. Otherwise, estimate GM tissue parameters locally in  patches of ``ww`` size,</span>
<span class="sd">         and test the likelihood of the pixel to belong in the GM distribution.</span>

<span class="sd">    This procedure is inspired on mindboggle&#39;s solution to the problem:</span>
<span class="sd">    https://github.com/nipy/mindboggle/blob/7f91faaa7664d820fe12ccc52ebaf21d679795e2/mindboggle/guts/segment.py#L1660</span>

<span class="sd">    The final phase resumes reconstruction, using the T2w image to assist</span>
<span class="sd">    in finding the pial surface, if available.</span>
<span class="sd">    See :py:func:`~smriprep.workflows.surfaces.init_autorecon_resume_wf` for details.</span>

<span class="sd">    Memory annotations for FreeSurfer are based off `their documentation</span>
<span class="sd">    &lt;https://surfer.nmr.mgh.harvard.edu/fswiki/SystemRequirements&gt;`_.</span>
<span class="sd">    They specify an allocation of 4GB per subject. Here we define 5GB</span>
<span class="sd">    to have a certain margin.</span>

<span class="sd">    Workflow Graph</span>
<span class="sd">        .. workflow::</span>
<span class="sd">            :graph2use: orig</span>
<span class="sd">            :simple_form: yes</span>

<span class="sd">            from smriprep.workflows.surfaces import init_surface_recon_wf</span>
<span class="sd">            wf = init_surface_recon_wf(</span>
<span class="sd">                omp_nthreads=1,</span>
<span class="sd">                hires=True,</span>
<span class="sd">                fs_no_resume=False,</span>
<span class="sd">                precomputed={})</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    omp_nthreads : int</span>
<span class="sd">        Maximum number of threads an individual process may use</span>
<span class="sd">    hires : bool</span>
<span class="sd">        Enable sub-millimeter preprocessing in FreeSurfer</span>
<span class="sd">    fs_no_resume : bool</span>
<span class="sd">        use precomputed freesurfer without attempting to resume</span>
<span class="sd">        (eg. for longitudinal base or fastsurfer)</span>

<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    t1w</span>
<span class="sd">        List of T1-weighted structural images</span>
<span class="sd">    t2w</span>
<span class="sd">        List of T2-weighted structural images (only first used)</span>
<span class="sd">    flair</span>
<span class="sd">        List of FLAIR images</span>
<span class="sd">    skullstripped_t1</span>
<span class="sd">        Skull-stripped T1-weighted image (or mask of image)</span>
<span class="sd">    subjects_dir</span>
<span class="sd">        FreeSurfer SUBJECTS_DIR</span>
<span class="sd">    subject_id</span>
<span class="sd">        FreeSurfer subject ID</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    subjects_dir</span>
<span class="sd">        FreeSurfer SUBJECTS_DIR</span>
<span class="sd">    subject_id</span>
<span class="sd">        FreeSurfer subject ID</span>
<span class="sd">    fsnative2t1w_xfm</span>
<span class="sd">        LTA-style affine matrix translating from FreeSurfer-conformed subject space to T1w</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    * :py:func:`~smriprep.workflows.surfaces.init_autorecon_resume_wf`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="n">workflow</span><span class="o">.</span><span class="n">__desc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Brain surfaces were reconstructed using `recon-all` [FreeSurfer </span><span class="si">{fs_ver}</span><span class="s2">,</span>
<span class="s2">RRID:SCR_001847, @fs_reconall], and the brain mask estimated</span>
<span class="s2">previously was refined with a custom variation of the method to reconcile</span>
<span class="s2">ANTs-derived and FreeSurfer-derived segmentations of the cortical</span>
<span class="s2">gray-matter of Mindboggle [RRID:SCR_002438, @mindboggle].</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fs_ver</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">Info</span><span class="p">()</span><span class="o">.</span><span class="n">looseversion</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;&lt;ver&gt;&#39;</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;t1w&#39;</span><span class="p">,</span>
                <span class="s1">&#39;t2w&#39;</span><span class="p">,</span>
                <span class="s1">&#39;flair&#39;</span><span class="p">,</span>
                <span class="s1">&#39;skullstripped_t1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span>
                <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span>
                <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span>
                <span class="s1">&#39;t1w2fsnative_xfm&#39;</span><span class="p">,</span>
                <span class="s1">&#39;fsnative2t1w_xfm&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">recon_config</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">FSDetectInputs</span><span class="p">(</span><span class="n">hires_enabled</span><span class="o">=</span><span class="n">hires</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;recon_config&#39;</span><span class="p">)</span>

    <span class="n">fov_check</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">_check_cw256</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fov_check&#39;</span><span class="p">)</span>
    <span class="n">fov_check</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">default_flags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-noskullstrip&#39;</span><span class="p">,</span> <span class="s1">&#39;-noT2pial&#39;</span><span class="p">,</span> <span class="s1">&#39;-noFLAIRpial&#39;</span><span class="p">]</span>

    <span class="n">autorecon1</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">ReconAll</span><span class="p">(</span><span class="n">directive</span><span class="o">=</span><span class="s1">&#39;autorecon1&#39;</span><span class="p">,</span> <span class="n">openmp</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;autorecon1&#39;</span><span class="p">,</span>
        <span class="n">n_procs</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
        <span class="n">mem_gb</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">autorecon1</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">_can_resume</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">autorecon1</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">_always_run</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">skull_strip_extern</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">FSInjectBrainExtracted</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;skull_strip_extern&#39;</span><span class="p">)</span>

    <span class="n">autorecon_resume_wf</span> <span class="o">=</span> <span class="n">init_autorecon_resume_wf</span><span class="p">(</span><span class="n">omp_nthreads</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">)</span>

    <span class="n">get_surfaces</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">FreeSurferSource</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_surfaces&#39;</span><span class="p">)</span>

    <span class="n">midthickness</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">MakeMidthickness</span><span class="p">(</span><span class="n">thickness</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">out_name</span><span class="o">=</span><span class="s1">&#39;midthickness&#39;</span><span class="p">),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;midthickness&#39;</span><span class="p">,</span>
        <span class="n">n_procs</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">omp_nthreads</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">save_midthickness</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">nio</span><span class="o">.</span><span class="n">DataSink</span><span class="p">(</span><span class="n">parameterization</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;save_midthickness&#39;</span><span class="p">)</span>

    <span class="n">sync</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
            <span class="n">function</span><span class="o">=</span><span class="n">_extract_fs_fields</span><span class="p">,</span>
            <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sync&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">fs_no_resume</span><span class="p">:</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="c1"># Configuration</span>
            <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">recon_config</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t1w&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_list&#39;</span><span class="p">),</span>
                                       <span class="p">(</span><span class="s1">&#39;t2w&#39;</span><span class="p">,</span> <span class="s1">&#39;t2w_list&#39;</span><span class="p">),</span>
                                       <span class="p">(</span><span class="s1">&#39;flair&#39;</span><span class="p">,</span> <span class="s1">&#39;flair_list&#39;</span><span class="p">)]),</span>
            <span class="c1"># Passing subjects_dir / subject_id enforces serial order</span>
            <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">autorecon1</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
                                     <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">autorecon1</span><span class="p">,</span> <span class="n">skull_strip_extern</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
                                              <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">skull_strip_extern</span><span class="p">,</span> <span class="n">autorecon_resume_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subjects_dir&#39;</span><span class="p">),</span>
                                                       <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subject_id&#39;</span><span class="p">)]),</span>
            <span class="c1"># Reconstruction phases</span>
            <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">autorecon1</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t1w&#39;</span><span class="p">,</span> <span class="s1">&#39;T1_files&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">fov_check</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t1w&#39;</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">fov_check</span><span class="p">,</span> <span class="n">autorecon1</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;flags&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">recon_config</span><span class="p">,</span> <span class="n">autorecon1</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t2w&#39;</span><span class="p">,</span> <span class="s1">&#39;T2_file&#39;</span><span class="p">),</span>
                                        <span class="p">(</span><span class="s1">&#39;flair&#39;</span><span class="p">,</span> <span class="s1">&#39;FLAIR_file&#39;</span><span class="p">),</span>
                                        <span class="p">(</span><span class="s1">&#39;hires&#39;</span><span class="p">,</span> <span class="s1">&#39;hires&#39;</span><span class="p">),</span>
                                        <span class="c1"># First run only (recon-all saves expert options)</span>
                                        <span class="p">(</span><span class="s1">&#39;mris_inflate&#39;</span><span class="p">,</span> <span class="s1">&#39;mris_inflate&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">skull_strip_extern</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;skullstripped_t1&#39;</span><span class="p">,</span> <span class="s1">&#39;in_brain&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">recon_config</span><span class="p">,</span> <span class="n">autorecon_resume_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;use_t2w&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.use_T2&#39;</span><span class="p">),</span>
                                                 <span class="p">(</span><span class="s1">&#39;use_flair&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.use_FLAIR&#39;</span><span class="p">)]),</span>
            <span class="c1"># Generate mid-thickness surfaces</span>
            <span class="p">(</span><span class="n">autorecon_resume_wf</span><span class="p">,</span> <span class="n">get_surfaces</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">autorecon_resume_wf</span><span class="p">,</span> <span class="n">save_midthickness</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;base_directory&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;container&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Pretend to be the autorecon1 node so fsnative2t1w_xfm gets run ASAP</span>
        <span class="n">fs_base_inputs</span> <span class="o">=</span> <span class="n">autorecon1</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">FreeSurferSource</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fs_base_inputs&#39;</span><span class="p">)</span>

        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">fs_base_inputs</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="c1"># Generate mid-thickness surfaces</span>
            <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">get_surfaces</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">save_midthickness</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;base_directory&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;container&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">get_surfaces</span><span class="p">,</span> <span class="n">midthickness</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;graymid&#39;</span><span class="p">,</span> <span class="s1">&#39;graymid&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">midthickness</span><span class="p">,</span> <span class="n">save_midthickness</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;surf.@graymid&#39;</span><span class="p">)]),</span>
        <span class="c1"># Output</span>
        <span class="p">(</span><span class="n">save_midthickness</span><span class="p">,</span> <span class="n">sync</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;filenames&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
                            <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="k">if</span> <span class="s1">&#39;fsnative&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">precomputed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transforms&#39;</span><span class="p">,</span> <span class="p">{}):</span>
        <span class="n">fsnative2t1w_xfm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
            <span class="n">RobustRegister</span><span class="p">(</span><span class="n">auto_sens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">est_int_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fsnative2t1w_xfm&#39;</span>
        <span class="p">)</span>

        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">fsnative2t1w_xfm</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t1w&#39;</span><span class="p">,</span> <span class="s1">&#39;target_file&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">autorecon1</span><span class="p">,</span> <span class="n">fsnative2t1w_xfm</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;T1&#39;</span><span class="p">,</span> <span class="s1">&#39;source_file&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">fsnative2t1w_xfm</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_reg_file&#39;</span><span class="p">,</span> <span class="s1">&#39;fsnative2t1w_xfm&#39;</span><span class="p">)]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="k">return</span> <span class="n">workflow</span></div>



<div class="viewcode-block" id="init_refinement_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.surfaces.html#smriprep.workflows.surfaces.init_refinement_wf">[docs]</a>
<span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;anat.mask-refine&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_refinement_wf</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span> <span class="n">image_type</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;T2w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;T1w&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;refinement_wf&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Workflow</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Refine ANTs brain extraction with FreeSurfer segmentation</span>

<span class="sd">    Workflow Graph</span>
<span class="sd">        .. workflow::</span>
<span class="sd">            :graph2use: orig</span>
<span class="sd">            :simple_form: yes</span>

<span class="sd">            from smriprep.workflows.surfaces import init_refinement_wf</span>
<span class="sd">            wf = init_refinement_wf()</span>

<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    subjects_dir</span>
<span class="sd">        FreeSurfer SUBJECTS_DIR</span>
<span class="sd">    subject_id</span>
<span class="sd">        FreeSurfer subject ID</span>
<span class="sd">    fsnative2anat_xfm</span>
<span class="sd">        LTA-style affine matrix translating from FreeSurfer-conformed subject space to anatomical</span>
<span class="sd">    reference_image</span>
<span class="sd">        Input</span>
<span class="sd">    ants_segs</span>
<span class="sd">        Brain tissue segmentation from ANTS ``antsBrainExtraction.sh``</span>
<span class="sd">    subjects_dir</span>
<span class="sd">        FreeSurfer SUBJECTS_DIR</span>
<span class="sd">    subject_id</span>
<span class="sd">        FreeSurfer subject ID</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    out_brainmask</span>
<span class="sd">        Refined brainmask, derived from FreeSurfer&#39;s ``aseg`` volume</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    * :py:func:`~smriprep.workflows.surfaces.init_autorecon_resume_wf`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="n">workflow</span><span class="o">.</span><span class="n">__desc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Brain surfaces were reconstructed using `recon-all` [FreeSurfer </span><span class="si">{fs_ver}</span><span class="s2">,</span>
<span class="s2">RRID:SCR_001847, @fs_reconall], and the brain mask estimated</span>
<span class="s2">previously was refined with a custom variation of the method to reconcile</span>
<span class="s2">ANTs-derived and FreeSurfer-derived segmentations of the cortical</span>
<span class="s2">gray-matter of Mindboggle [RRID:SCR_002438, @mindboggle].</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fs_ver</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">Info</span><span class="p">()</span><span class="o">.</span><span class="n">looseversion</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;&lt;ver&gt;&#39;</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;reference_image&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ants_segs&#39;</span><span class="p">,</span>
                <span class="s1">&#39;fsnative2anat_xfm&#39;</span><span class="p">,</span>
                <span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span>
                <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;out_brainmask&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">aseg_to_native_wf</span> <span class="o">=</span> <span class="n">init_segs_to_native_wf</span><span class="p">(</span><span class="n">image_type</span><span class="o">=</span><span class="n">image_type</span><span class="p">)</span>
    <span class="n">refine</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">RefineBrainMask</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;refine&#39;</span><span class="p">)</span>

    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="c1"># Refine ANTs mask, deriving new mask from FS&#39; aseg</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">aseg_to_native_wf</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subjects_dir&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subject_id&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;reference_image&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.in_file&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;fsnative2anat_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.fsnative2anat_xfm&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">refine</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;reference_image&#39;</span><span class="p">,</span> <span class="s1">&#39;in_anat&#39;</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">&#39;ants_segs&#39;</span><span class="p">,</span> <span class="s1">&#39;in_ants&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">aseg_to_native_wf</span><span class="p">,</span> <span class="n">refine</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_aseg&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">refine</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;out_brainmask&#39;</span><span class="p">)]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="k">return</span> <span class="n">workflow</span></div>



<div class="viewcode-block" id="init_autorecon_resume_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.surfaces.html#smriprep.workflows.surfaces.init_autorecon_resume_wf">[docs]</a>
<span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;anat.fs-autorecon-resume&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_autorecon_resume_wf</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">omp_nthreads</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;autorecon_resume_wf&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resume recon-all execution, assuming the `-autorecon1` stage has been completed.</span>

<span class="sd">    In order to utilize resources efficiently, this is broken down into seven</span>
<span class="sd">    sub-stages; after the first stage, the second and third stages may be run</span>
<span class="sd">    simultaneously, and the fifth and sixth stages may be run simultaneously,</span>
<span class="sd">    if resources permit; the fourth stage must be run prior to the fifth and</span>
<span class="sd">    sixth, and the seventh must be run after::</span>

<span class="sd">        $ recon-all -sd &lt;output dir&gt;/freesurfer -subjid sub-&lt;subject_label&gt; \</span>
<span class="sd">            -autorecon2-volonly</span>
<span class="sd">        $ recon-all -sd &lt;output dir&gt;/freesurfer -subjid sub-&lt;subject_label&gt; \</span>
<span class="sd">            -autorecon-hemi lh -T2pial \</span>
<span class="sd">            -noparcstats -noparcstats2 -noparcstats3 -nohyporelabel -nobalabels</span>
<span class="sd">        $ recon-all -sd &lt;output dir&gt;/freesurfer -subjid sub-&lt;subject_label&gt; \</span>
<span class="sd">            -autorecon-hemi rh -T2pial \</span>
<span class="sd">            -noparcstats -noparcstats2 -noparcstats3 -nohyporelabel -nobalabels</span>
<span class="sd">        $ recon-all -sd &lt;output dir&gt;/freesurfer -subjid sub-&lt;subject_label&gt; \</span>
<span class="sd">            -cortribbon</span>
<span class="sd">        $ recon-all -sd &lt;output dir&gt;/freesurfer -subjid sub-&lt;subject_label&gt; \</span>
<span class="sd">            -autorecon-hemi lh -nohyporelabel</span>
<span class="sd">        $ recon-all -sd &lt;output dir&gt;/freesurfer -subjid sub-&lt;subject_label&gt; \</span>
<span class="sd">            -autorecon-hemi rh -nohyporelabel</span>
<span class="sd">        $ recon-all -sd &lt;output dir&gt;/freesurfer -subjid sub-&lt;subject_label&gt; \</span>
<span class="sd">            -autorecon3</span>

<span class="sd">    The parcellation statistics steps are excluded from the second and third</span>
<span class="sd">    stages, because they require calculation of the cortical ribbon volume</span>
<span class="sd">    (the fourth stage).</span>
<span class="sd">    Hypointensity relabeling is excluded from hemisphere-specific steps to avoid</span>
<span class="sd">    race conditions, as it is a volumetric operation.</span>

<span class="sd">    Workflow Graph</span>
<span class="sd">        .. workflow::</span>
<span class="sd">            :graph2use: orig</span>
<span class="sd">            :simple_form: yes</span>

<span class="sd">            from smriprep.workflows.surfaces import init_autorecon_resume_wf</span>
<span class="sd">            wf = init_autorecon_resume_wf(omp_nthreads=1)</span>

<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    subjects_dir</span>
<span class="sd">        FreeSurfer SUBJECTS_DIR</span>
<span class="sd">    subject_id</span>
<span class="sd">        FreeSurfer subject ID</span>
<span class="sd">    use_T2</span>
<span class="sd">        Refine pial surface using T2w image</span>
<span class="sd">    use_FLAIR</span>
<span class="sd">        Refine pial surface using FLAIR image</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    subjects_dir</span>
<span class="sd">        FreeSurfer SUBJECTS_DIR</span>
<span class="sd">    subject_id</span>
<span class="sd">        FreeSurfer subject ID</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;use_T2&#39;</span><span class="p">,</span> <span class="s1">&#39;use_FLAIR&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span>
    <span class="p">)</span>

    <span class="c1"># FreeSurfer 7.3 removed gcareg from autorecon2-volonly</span>
    <span class="c1"># Adding it directly in would force it to run every time</span>
    <span class="n">gcareg</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">ReconAll</span><span class="p">(</span><span class="n">directive</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gcareg&#39;</span><span class="p">],</span> <span class="n">openmp</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">),</span>
        <span class="n">n_procs</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
        <span class="n">mem_gb</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;gcareg&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">gcareg</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">_always_run</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">autorecon2_vol</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">ReconAll</span><span class="p">(</span><span class="n">directive</span><span class="o">=</span><span class="s1">&#39;autorecon2-volonly&#39;</span><span class="p">,</span> <span class="n">openmp</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">),</span>
        <span class="n">n_procs</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
        <span class="n">mem_gb</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;autorecon2_vol&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">autorecon2_vol</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">_always_run</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">autorecon_surfs</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">ReconAll</span><span class="p">(</span>
            <span class="n">directive</span><span class="o">=</span><span class="s1">&#39;autorecon-hemi&#39;</span><span class="p">,</span>
            <span class="n">flags</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;-noparcstats&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-noparcstats2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-noparcstats3&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-nohyporelabel&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-nobalabels&#39;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">openmp</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="s1">&#39;hemi&#39;</span><span class="p">,</span>
        <span class="n">n_procs</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
        <span class="n">mem_gb</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;autorecon_surfs&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">autorecon_surfs</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">hemi</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lh&#39;</span><span class="p">,</span> <span class="s1">&#39;rh&#39;</span><span class="p">]</span>
    <span class="n">autorecon_surfs</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">_always_run</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># -cortribbon is a prerequisite for -parcstats, -parcstats2, -parcstats3</span>
    <span class="c1"># Claiming two threads because pial refinement can be split by hemisphere</span>
    <span class="c1"># if -T2pial or -FLAIRpial is enabled.</span>
    <span class="c1"># Parallelizing by hemisphere saves ~30 minutes over simply enabling</span>
    <span class="c1"># OpenMP on an 8 core machine.</span>
    <span class="n">cortribbon</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">ReconAll</span><span class="p">(</span><span class="n">directive</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cortribbon&#39;</span><span class="p">],</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">n_procs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cortribbon&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">cortribbon</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">_always_run</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># -parcstats* can be run per-hemisphere</span>
    <span class="c1"># -hyporelabel is volumetric, even though it&#39;s part of -autorecon-hemi</span>
    <span class="n">parcstats</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">ReconAll</span><span class="p">(</span><span class="n">directive</span><span class="o">=</span><span class="s1">&#39;autorecon-hemi&#39;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-nohyporelabel&#39;</span><span class="p">],</span> <span class="n">openmp</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="s1">&#39;hemi&#39;</span><span class="p">,</span>
        <span class="n">n_procs</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
        <span class="n">mem_gb</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;parcstats&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parcstats</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">hemi</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lh&#39;</span><span class="p">,</span> <span class="s1">&#39;rh&#39;</span><span class="p">]</span>
    <span class="n">parcstats</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">_always_run</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Runs: -hyporelabel -aparc2aseg -apas2aseg -segstats -wmparc</span>
    <span class="c1"># All volumetric, so don&#39;t</span>
    <span class="n">autorecon3</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">ReconAll</span><span class="p">(</span><span class="n">directive</span><span class="o">=</span><span class="s1">&#39;autorecon3&#39;</span><span class="p">,</span> <span class="n">openmp</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">),</span>
        <span class="n">n_procs</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
        <span class="n">mem_gb</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;autorecon3&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">autorecon3</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">_always_run</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_dedup</span><span class="p">(</span><span class="n">in_list</span><span class="p">):</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">in_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Non-identical values can&#39;t be deduplicated:</span><span class="se">\n</span><span class="si">{</span><span class="n">in_list</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">cortribbon</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;use_T2&#39;</span><span class="p">,</span> <span class="s1">&#39;use_T2&#39;</span><span class="p">),</span>
                                 <span class="p">(</span><span class="s1">&#39;use_FLAIR&#39;</span><span class="p">,</span> <span class="s1">&#39;use_FLAIR&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">gcareg</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">gcareg</span><span class="p">,</span> <span class="n">autorecon2_vol</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
                                  <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">autorecon2_vol</span><span class="p">,</span> <span class="n">autorecon_surfs</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
                                           <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">autorecon_surfs</span><span class="p">,</span> <span class="n">cortribbon</span><span class="p">,</span> <span class="p">[((</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="n">_dedup</span><span class="p">),</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
                                       <span class="p">((</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">_dedup</span><span class="p">),</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">cortribbon</span><span class="p">,</span> <span class="n">parcstats</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
                                 <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">parcstats</span><span class="p">,</span> <span class="n">autorecon3</span><span class="p">,</span> <span class="p">[((</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="n">_dedup</span><span class="p">),</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
                                 <span class="p">((</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">_dedup</span><span class="p">),</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">autorecon3</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
                                  <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="k">return</span> <span class="n">workflow</span></div>



<div class="viewcode-block" id="init_surface_derivatives_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.surfaces.html#smriprep.workflows.surfaces.init_surface_derivatives_wf">[docs]</a>
<span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;anat.surface-derivatives&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_surface_derivatives_wf</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">image_type</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;T2w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;T1w&#39;</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;surface_derivatives_wf&#39;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate sMRIPrep derivatives from FreeSurfer derivatives</span>

<span class="sd">    Workflow Graph</span>
<span class="sd">        .. workflow::</span>
<span class="sd">            :graph2use: orig</span>
<span class="sd">            :simple_form: yes</span>

<span class="sd">            from smriprep.workflows.surfaces import init_surface_derivatives_wf</span>
<span class="sd">            wf = init_surface_derivatives_wf()</span>

<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    reference</span>
<span class="sd">        Reference image in native anatomical space, for defining a resampling grid</span>
<span class="sd">    fsnative2anat_xfm</span>
<span class="sd">        LTA-style affine matrix translating from FreeSurfer-conformed subject space to anatomical</span>
<span class="sd">    subjects_dir</span>
<span class="sd">        FreeSurfer SUBJECTS_DIR</span>
<span class="sd">    subject_id</span>
<span class="sd">        FreeSurfer subject ID</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    surfaces</span>
<span class="sd">        GIFTI surfaces for gray/white matter boundary, pial surface,</span>
<span class="sd">        midthickness (or graymid) surface, and inflated surfaces</span>
<span class="sd">    morphometrics</span>
<span class="sd">        GIFTIs of cortical thickness, curvature, and sulcal depth</span>
<span class="sd">    out_aseg</span>
<span class="sd">        FreeSurfer&#39;s aseg segmentation, in native anatomical space</span>
<span class="sd">    out_aparc</span>
<span class="sd">        FreeSurfer&#39;s aparc+aseg segmentation, in native anatomical space</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    * :py:func:`~smriprep.workflows.surfaces.init_gifti_surface_wf`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span>
                <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span>
                <span class="s1">&#39;fsnative2anat_xfm&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reference&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;inflated&#39;</span><span class="p">,</span>
                <span class="s1">&#39;curv&#39;</span><span class="p">,</span>
                <span class="s1">&#39;out_aseg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;out_aparc&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">gifti_surfaces_wf</span> <span class="o">=</span> <span class="n">init_gifti_surfaces_wf</span><span class="p">(</span><span class="n">surfaces</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;inflated&#39;</span><span class="p">])</span>
    <span class="n">gifti_morph_wf</span> <span class="o">=</span> <span class="n">init_gifti_morphometrics_wf</span><span class="p">(</span><span class="n">morphometrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;curv&#39;</span><span class="p">])</span>
    <span class="n">aseg_to_native_wf</span> <span class="o">=</span> <span class="n">init_segs_to_native_wf</span><span class="p">(</span><span class="n">image_type</span><span class="o">=</span><span class="n">image_type</span><span class="p">)</span>
    <span class="n">aparc_to_native_wf</span> <span class="o">=</span> <span class="n">init_segs_to_native_wf</span><span class="p">(</span><span class="n">image_type</span><span class="o">=</span><span class="n">image_type</span><span class="p">,</span> <span class="n">segmentation</span><span class="o">=</span><span class="s1">&#39;aparc_aseg&#39;</span><span class="p">)</span>

    <span class="c1"># fmt:off</span>
    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="c1"># Configuration</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">gifti_surfaces_wf</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subjects_dir&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subject_id&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;fsnative2anat_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.fsnative2anat_xfm&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">gifti_morph_wf</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subjects_dir&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subject_id&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">aseg_to_native_wf</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subjects_dir&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subject_id&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.in_file&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;fsnative2anat_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.fsnative2anat_xfm&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">aparc_to_native_wf</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subjects_dir&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subject_id&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.in_file&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;fsnative2anat_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.fsnative2anat_xfm&#39;</span><span class="p">),</span>
        <span class="p">]),</span>

        <span class="c1"># Output</span>
        <span class="p">(</span><span class="n">gifti_surfaces_wf</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.inflated&#39;</span><span class="p">,</span> <span class="s1">&#39;inflated&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">aseg_to_native_wf</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;out_aseg&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">aparc_to_native_wf</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;out_aparc&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">gifti_morph_wf</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.curv&#39;</span><span class="p">,</span> <span class="s1">&#39;curv&#39;</span><span class="p">)]),</span>
    <span class="p">])</span>
    <span class="c1"># fmt:on</span>

    <span class="k">return</span> <span class="n">workflow</span></div>



<div class="viewcode-block" id="init_fsLR_reg_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.surfaces.html#smriprep.workflows.surfaces.init_fsLR_reg_wf">[docs]</a>
<span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;anat.fslr-reg&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_fsLR_reg_wf</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fsLR_reg_wf&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate GIFTI registration files to fsLR space&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">..interfaces.workbench</span><span class="w"> </span><span class="kn">import</span> <span class="n">SurfaceSphereProjectUnproject</span>

    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">([</span><span class="s1">&#39;sphere_reg&#39;</span><span class="p">,</span> <span class="s1">&#39;sulc&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">)</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">([</span><span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">)</span>

    <span class="c1"># Via</span>
    <span class="c1"># ${CARET7DIR}/wb_command -surface-sphere-project-unproject</span>
    <span class="c1">#   &quot;$NativeFolder&quot;/&quot;$Subject&quot;.&quot;$Hemisphere&quot;.sphere.reg.native.surf.gii</span>
    <span class="c1">#   fsaverage/&quot;$Subject&quot;.&quot;$Hemisphere&quot;.sphere.&quot;$HighResMesh&quot;k_fs_&quot;$Hemisphere&quot;.surf.gii</span>
    <span class="c1">#   fsaverage/&quot;$Subject&quot;.&quot;$Hemisphere&quot;.def_sphere.&quot;$HighResMesh&quot;k_fs_&quot;$Hemisphere&quot;.surf.gii</span>
    <span class="c1">#   &quot;$NativeFolder&quot;/&quot;$Subject&quot;.&quot;$Hemisphere&quot;.sphere.reg.reg_LR.native.surf.gii</span>
    <span class="n">project_unproject</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">SurfaceSphereProjectUnproject</span><span class="p">(),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sphere_in&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_project_to&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_unproject_from&#39;</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;project_unproject&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">atlases</span> <span class="o">=</span> <span class="n">smriprep</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;atlases&#39;</span><span class="p">)</span>
    <span class="n">project_unproject</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">sphere_project_to</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">atlases</span> <span class="o">/</span> <span class="s1">&#39;fs_L&#39;</span> <span class="o">/</span> <span class="s1">&#39;fsaverage.L.sphere.164k_fs_L.surf.gii&#39;</span><span class="p">,</span>
        <span class="n">atlases</span> <span class="o">/</span> <span class="s1">&#39;fs_R&#39;</span> <span class="o">/</span> <span class="s1">&#39;fsaverage.R.sphere.164k_fs_R.surf.gii&#39;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">project_unproject</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">sphere_unproject_from</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">atlases</span> <span class="o">/</span> <span class="s1">&#39;fs_L&#39;</span> <span class="o">/</span> <span class="s1">&#39;fs_L-to-fs_LR_fsaverage.L_LR.spherical_std.164k_fs_L.surf.gii&#39;</span><span class="p">,</span>
        <span class="n">atlases</span> <span class="o">/</span> <span class="s1">&#39;fs_R&#39;</span> <span class="o">/</span> <span class="s1">&#39;fs_R-to-fs_LR_fsaverage.R_LR.spherical_std.164k_fs_R.surf.gii&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># fmt:off</span>
    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">project_unproject</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;sphere_reg&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_in&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">project_unproject</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;sphere_out&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">)]),</span>
    <span class="p">])</span>
    <span class="c1"># fmt:on</span>

    <span class="k">return</span> <span class="n">workflow</span></div>



<div class="viewcode-block" id="init_msm_sulc_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.surfaces.html#smriprep.workflows.surfaces.init_msm_sulc_wf">[docs]</a>
<span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;anat.msm-sulc&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_msm_sulc_wf</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">sloppy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;msm_sulc_wf&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run MSMSulc registration to fsLR surfaces, per hemisphere.&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">..interfaces.msm</span><span class="w"> </span><span class="kn">import</span> <span class="n">MSM</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">..interfaces.workbench</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">SurfaceAffineRegression</span><span class="p">,</span>
        <span class="n">SurfaceApplyAffine</span><span class="p">,</span>
        <span class="n">SurfaceModifySphere</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sulc&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">)</span>

    <span class="c1"># 0) Calculate affine</span>
    <span class="c1"># ${CARET7DIR}/wb_command -surface-affine-regression \</span>
    <span class="c1"># $SUB.L.sphere.native.surf.gii  \</span>
    <span class="c1"># $SUB.sphere.reg.reg_LR.native.surf.gii \</span>
    <span class="c1"># &quot;$AtlasSpaceFolder&quot;/&quot;$NativeFolder&quot;/MSMSulc/${Hemisphere}.mat</span>
    <span class="n">regress_affine</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">SurfaceAffineRegression</span><span class="p">(),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_surface&#39;</span><span class="p">,</span> <span class="s1">&#39;target_surface&#39;</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;regress_affine&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 1) Apply affine to native sphere:</span>
    <span class="c1"># wb_command -surface-apply-affine \</span>
    <span class="c1"># ${SUB}.L.sphere.native.surf.gii \</span>
    <span class="c1"># L.mat \</span>
    <span class="c1"># ${SUB}.L.sphere_rot.native.surf.gii</span>
    <span class="n">apply_surface_affine</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">SurfaceApplyAffine</span><span class="p">(),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_surface&#39;</span><span class="p">,</span> <span class="s1">&#39;in_affine&#39;</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;apply_surface_affine&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Fix for oblongated sphere</span>
    <span class="n">modify_sphere</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">SurfaceModifySphere</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="mi">100</span><span class="p">),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_surface&#39;</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;modify_sphere&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 2) Invert sulc</span>
    <span class="c1"># wb_command -metric-math &quot;-1 * var&quot; ...</span>
    <span class="n">invert_sulc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">MetricMath</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;sulc&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;invert&#39;</span><span class="p">),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;metric_file&#39;</span><span class="p">,</span> <span class="s1">&#39;hemisphere&#39;</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;invert_sulc&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">invert_sulc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">hemisphere</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">]</span>

    <span class="c1"># 3) Run MSMSulc</span>
    <span class="c1"># ./msm_centos_v3 --conf=MSMSulcStrainFinalconf \</span>
    <span class="c1"># --inmesh=${SUB}.${HEMI}.sphere_rot.native.surf.gii</span>
    <span class="c1"># --refmesh=fsaverage.${HEMI}_LR.spherical_std.164k_fs_LR.surf.gii</span>
    <span class="c1"># --indata=sub-${SUB}_ses-${SES}_hemi-${HEMI)_sulc.shape.gii \</span>
    <span class="c1"># --refdata=tpl-fsaverage_hemi-${HEMI}_den-164k_sulc.shape.gii \</span>
    <span class="c1"># --out=${HEMI}. --verbose</span>
    <span class="n">atlases</span> <span class="o">=</span> <span class="n">smriprep</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;atlases&#39;</span><span class="p">)</span>
    <span class="n">msm_conf</span> <span class="o">=</span> <span class="n">smriprep</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;msm/MSMSulcStrain</span><span class="si">{</span><span class="s2">&quot;Sloppy&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">sloppy</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;Final&quot;</span><span class="si">}</span><span class="s1">conf&#39;</span><span class="p">)</span>
    <span class="n">msmsulc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">MSM</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">config_file</span><span class="o">=</span><span class="n">msm_conf</span><span class="p">),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_mesh&#39;</span><span class="p">,</span> <span class="s1">&#39;reference_mesh&#39;</span><span class="p">,</span> <span class="s1">&#39;in_data&#39;</span><span class="p">,</span> <span class="s1">&#39;reference_data&#39;</span><span class="p">,</span> <span class="s1">&#39;out_base&#39;</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;msmsulc&#39;</span><span class="p">,</span>
        <span class="n">mem_gb</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">msmsulc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_base</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lh.&#39;</span><span class="p">,</span> <span class="s1">&#39;rh.&#39;</span><span class="p">]</span>  <span class="c1"># To placate Path2BIDS</span>
    <span class="n">msmsulc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reference_mesh</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">atlases</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;fsaverage.</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_LR.spherical_std.164k_fs_LR.surf.gii&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="s1">&#39;LR&#39;</span>
    <span class="p">]</span>
    <span class="n">msmsulc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reference_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">atlases</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">.refsulc.164k_fs_LR.shape.gii&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="s1">&#39;LR&#39;</span>
    <span class="p">]</span>
    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">regress_affine</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;sphere&#39;</span><span class="p">,</span> <span class="s1">&#39;in_surface&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;target_surface&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">apply_surface_affine</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;sphere&#39;</span><span class="p">,</span> <span class="s1">&#39;in_surface&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">invert_sulc</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;sulc&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">regress_affine</span><span class="p">,</span> <span class="n">apply_surface_affine</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_affine&#39;</span><span class="p">,</span> <span class="s1">&#39;in_affine&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">apply_surface_affine</span><span class="p">,</span> <span class="n">modify_sphere</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_surface&#39;</span><span class="p">,</span> <span class="s1">&#39;in_surface&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">modify_sphere</span><span class="p">,</span> <span class="n">msmsulc</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_surface&#39;</span><span class="p">,</span> <span class="s1">&#39;in_mesh&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">invert_sulc</span><span class="p">,</span> <span class="n">msmsulc</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;metric_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_data&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">msmsulc</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;warped_mesh&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">)]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">return</span> <span class="n">workflow</span></div>



<div class="viewcode-block" id="init_gifti_surfaces_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.surfaces.html#smriprep.workflows.surfaces.init_gifti_surfaces_wf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">init_gifti_surfaces_wf</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">surfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;pial&#39;</span><span class="p">,</span> <span class="s1">&#39;midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;inflated&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">),</span>
    <span class="n">to_scanner</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;gifti_surface_wf&#39;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare GIFTI surfaces from a FreeSurfer subjects directory.</span>

<span class="sd">    The default surfaces are ``lh/rh.pial``, ``lh/rh.midthickness``,</span>
<span class="sd">    ``lh/rh.inflated``, and ``lh/rh.white``.</span>

<span class="sd">    Vertex coordinates are :py:class:`transformed</span>
<span class="sd">    &lt;smriprep.interfaces.NormalizeSurf&gt;` to align with native anatomical space</span>
<span class="sd">    when ``fsnative2anat_xfm`` is provided.</span>

<span class="sd">    Workflow Graph</span>
<span class="sd">        .. workflow::</span>
<span class="sd">            :graph2use: orig</span>
<span class="sd">            :simple_form: yes</span>

<span class="sd">            from smriprep.workflows.surfaces import init_gifti_surfaces_wf</span>
<span class="sd">            wf = init_gifti_surfaces_wf()</span>

<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    subjects_dir</span>
<span class="sd">        FreeSurfer SUBJECTS_DIR</span>
<span class="sd">    subject_id</span>
<span class="sd">        FreeSurfer subject ID</span>
<span class="sd">    fsnative2anat_xfm</span>
<span class="sd">        LTA formatted affine transform file</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    surfaces</span>
<span class="sd">        GIFTI surfaces for all requested surfaces</span>
<span class="sd">    ``&lt;surface&gt;``</span>
<span class="sd">        Left and right GIFTIs for each surface passed to ``surfaces``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">..interfaces.surf</span><span class="w"> </span><span class="kn">import</span> <span class="n">NormalizeSurf</span>

    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">([</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;fsnative2anat_xfm&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">([</span><span class="s1">&#39;surfaces&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">surfaces</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">)</span>

    <span class="n">get_surfaces</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">_get_surfaces</span><span class="p">,</span> <span class="n">output_names</span><span class="o">=</span><span class="n">surfaces</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_surfaces&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">get_surfaces</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">surfaces</span> <span class="o">=</span> <span class="n">surfaces</span>

    <span class="n">surface_list</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">surfaces</span><span class="p">),</span> <span class="n">ravel_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;surface_list&#39;</span><span class="p">,</span>
        <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fs2gii</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">fs</span><span class="o">.</span><span class="n">MRIsConvert</span><span class="p">(</span><span class="n">out_datatype</span><span class="o">=</span><span class="s1">&#39;gii&#39;</span><span class="p">,</span> <span class="n">to_scanner</span><span class="o">=</span><span class="n">to_scanner</span><span class="p">),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fs2gii&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fix_surfs</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">NormalizeSurf</span><span class="p">(),</span> <span class="n">iterfield</span><span class="o">=</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fix_surfs&#39;</span><span class="p">)</span>

    <span class="n">surface_groups</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">splits</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">surfaces</span><span class="p">)),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;surface_groups&#39;</span><span class="p">,</span>
        <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">get_surfaces</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">fix_surfs</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;fsnative2anat_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;transform_file&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">get_surfaces</span><span class="p">,</span> <span class="n">surface_list</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">surf</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;in</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">surf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">surfaces</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">surface_list</span><span class="p">,</span> <span class="n">fs2gii</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">fs2gii</span><span class="p">,</span> <span class="n">fix_surfs</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;converted&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">fix_surfs</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;surfaces&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">fix_surfs</span><span class="p">,</span> <span class="n">surface_groups</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;inlist&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">surface_groups</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;out</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">surf</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">surf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">surfaces</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">return</span> <span class="n">workflow</span></div>



<div class="viewcode-block" id="init_gifti_morphometrics_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.surfaces.html#smriprep.workflows.surfaces.init_gifti_morphometrics_wf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">init_gifti_morphometrics_wf</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">morphometrics</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;curv&#39;</span><span class="p">,</span> <span class="s1">&#39;sulc&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;gifti_morphometrics_wf&#39;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare GIFTI shape files from morphometrics found in a FreeSurfer subjects</span>
<span class="sd">    directory.</span>

<span class="sd">    The default morphometrics are ``lh/rh.thickness``, ``lh/rh.curv``, and</span>
<span class="sd">    ``lh/rh.sulc``.</span>

<span class="sd">    Workflow Graph</span>
<span class="sd">        .. workflow::</span>
<span class="sd">            :graph2use: orig</span>
<span class="sd">            :simple_form: yes</span>

<span class="sd">            from smriprep.workflows.surfaces import init_gifti_morphometrics_wf</span>
<span class="sd">            wf = init_gifti_morphometrics_wf()</span>

<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    subjects_dir</span>
<span class="sd">        FreeSurfer SUBJECTS_DIR</span>
<span class="sd">    subject_id</span>
<span class="sd">        FreeSurfer subject ID</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    morphometrics</span>
<span class="sd">        GIFTI shape files for all requested morphometrics</span>
<span class="sd">    ``&lt;morphometric&gt;``</span>
<span class="sd">        Left and right GIFTIs for each morphometry type passed to ``morphometrics``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">..interfaces.freesurfer</span><span class="w"> </span><span class="kn">import</span> <span class="n">MRIsConvertData</span>

    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">([</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s1">&#39;morphometrics&#39;</span><span class="p">,</span>
                <span class="o">*</span><span class="n">morphometrics</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">get_subject</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">FreeSurferSource</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_surfaces&#39;</span><span class="p">)</span>

    <span class="n">morphometry_list</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">morphometrics</span><span class="p">),</span> <span class="n">ravel_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;surfmorph_list&#39;</span><span class="p">,</span>
        <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">morphs2gii</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">MRIsConvertData</span><span class="p">(</span><span class="n">out_datatype</span><span class="o">=</span><span class="s1">&#39;gii&#39;</span><span class="p">),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="s1">&#39;scalarcurv_file&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;morphs2gii&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">morph_groups</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">splits</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">morphometrics</span><span class="p">)),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;morph_groups&#39;</span><span class="p">,</span>
        <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># fmt:off</span>
    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">get_subject</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
                                  <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">get_subject</span><span class="p">,</span> <span class="n">morphometry_list</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">((</span><span class="n">morph</span><span class="p">,</span> <span class="n">_sorted_by_basename</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;in</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">morph</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">morphometrics</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">morphometry_list</span><span class="p">,</span> <span class="n">morphs2gii</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;scalarcurv_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">morphs2gii</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;converted&#39;</span><span class="p">,</span> <span class="s1">&#39;morphometrics&#39;</span><span class="p">)]),</span>
        <span class="c1"># Output individual surfaces as well</span>
        <span class="p">(</span><span class="n">morphs2gii</span><span class="p">,</span> <span class="n">morph_groups</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;converted&#39;</span><span class="p">,</span> <span class="s1">&#39;inlist&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">morph_groups</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;out</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">surf</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">surf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">morphometrics</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">]),</span>
    <span class="p">])</span>
    <span class="c1"># fmt:on</span>
    <span class="k">return</span> <span class="n">workflow</span></div>



<div class="viewcode-block" id="init_hcp_morphometrics_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.surfaces.html#smriprep.workflows.surfaces.init_hcp_morphometrics_wf">[docs]</a>
<span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;anat.hcp-morphs&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_hcp_morphometrics_wf</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">omp_nthreads</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;hcp_morphometrics_wf&#39;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Workflow</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert FreeSurfer-style morphometrics to HCP-style.</span>

<span class="sd">    The HCP uses different conventions for curvature and sulcal depth from FreeSurfer,</span>
<span class="sd">    and performs some geometric preprocessing steps to get final metrics and a</span>
<span class="sd">    subject-specific cortical ROI.</span>

<span class="sd">    Workflow Graph</span>

<span class="sd">    .. workflow::</span>

<span class="sd">        from smriprep.workflows.surfaces import init_hcp_morphometrics_wf</span>
<span class="sd">        wf = init_hcp_morphometrics_wf(omp_nthreads=1)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    omp_nthreads</span>
<span class="sd">        Maximum number of threads an individual process may use</span>

<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    subject_id</span>
<span class="sd">        FreeSurfer subject ID</span>
<span class="sd">    thickness</span>
<span class="sd">        FreeSurfer thickness file in GIFTI format</span>
<span class="sd">    curv</span>
<span class="sd">        FreeSurfer curvature file in GIFTI format</span>
<span class="sd">    sulc</span>
<span class="sd">        FreeSurfer sulcal depth file in GIFTI format</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    thickness</span>
<span class="sd">        HCP-style thickness file in GIFTI format</span>
<span class="sd">    curv</span>
<span class="sd">        HCP-style curvature file in GIFTI format</span>
<span class="sd">    sulc</span>
<span class="sd">        HCP-style sulcal depth file in GIFTI format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DEFAULT_MEMORY_MIN_GB</span> <span class="o">=</span> <span class="mf">0.01</span>

    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;curv&#39;</span><span class="p">,</span> <span class="s1">&#39;sulc&#39;</span><span class="p">,</span> <span class="s1">&#39;midthickness&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">itersource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hemi&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;itersource&#39;</span><span class="p">,</span>
        <span class="n">iterables</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;hemi&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">])],</span>
    <span class="p">)</span>

    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">JoinNode</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;curv&#39;</span><span class="p">,</span> <span class="s1">&#39;sulc&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">,</span>
        <span class="n">joinsource</span><span class="o">=</span><span class="s1">&#39;itersource&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">select_surfaces</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">KeySelect</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;thickness&#39;</span><span class="p">,</span>
                <span class="s1">&#39;curv&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sulc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;midthickness&#39;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;select_surfaces&#39;</span><span class="p">,</span>
        <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># HCP inverts curvature and sulcal depth relative to FreeSurfer</span>
    <span class="n">invert_curv</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">MetricMath</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;curv&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;invert&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;invert_curv&#39;</span><span class="p">)</span>
    <span class="n">invert_sulc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">MetricMath</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;sulc&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;invert&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;invert_sulc&#39;</span><span class="p">)</span>
    <span class="c1"># Thickness is presumably already positive, but HCP uses abs(-thickness)</span>
    <span class="n">abs_thickness</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">MetricMath</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;abs_thickness&#39;</span><span class="p">)</span>

    <span class="c1"># Dilation happens separately from ROI creation</span>
    <span class="n">dilate_curv</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">MetricDilate</span><span class="p">(</span><span class="n">distance</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">nearest</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dilate_curv&#39;</span><span class="p">,</span>
        <span class="n">n_procs</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
        <span class="n">mem_gb</span><span class="o">=</span><span class="n">DEFAULT_MEMORY_MIN_GB</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dilate_thickness</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">MetricDilate</span><span class="p">(</span><span class="n">distance</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">nearest</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dilate_thickness&#39;</span><span class="p">,</span>
        <span class="n">n_procs</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
        <span class="n">mem_gb</span><span class="o">=</span><span class="n">DEFAULT_MEMORY_MIN_GB</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">select_surfaces</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;thickness&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;curv&#39;</span><span class="p">,</span> <span class="s1">&#39;curv&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;sulc&#39;</span><span class="p">,</span> <span class="s1">&#39;sulc&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;midthickness&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">invert_curv</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">invert_sulc</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">abs_thickness</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">itersource</span><span class="p">,</span> <span class="n">select_surfaces</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;hemi&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">itersource</span><span class="p">,</span> <span class="n">invert_curv</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;hemi&#39;</span><span class="p">,</span> <span class="s1">&#39;hemisphere&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">itersource</span><span class="p">,</span> <span class="n">invert_sulc</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;hemi&#39;</span><span class="p">,</span> <span class="s1">&#39;hemisphere&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">itersource</span><span class="p">,</span> <span class="n">abs_thickness</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;hemi&#39;</span><span class="p">,</span> <span class="s1">&#39;hemisphere&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">select_surfaces</span><span class="p">,</span> <span class="n">invert_curv</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;curv&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">select_surfaces</span><span class="p">,</span> <span class="n">invert_sulc</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;sulc&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">select_surfaces</span><span class="p">,</span> <span class="n">abs_thickness</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">select_surfaces</span><span class="p">,</span> <span class="n">dilate_curv</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;surf_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">select_surfaces</span><span class="p">,</span> <span class="n">dilate_thickness</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;surf_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">invert_curv</span><span class="p">,</span> <span class="n">dilate_curv</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;metric_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">abs_thickness</span><span class="p">,</span> <span class="n">dilate_thickness</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;metric_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">dilate_curv</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;curv&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">dilate_thickness</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;thickness&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">invert_sulc</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;metric_file&#39;</span><span class="p">,</span> <span class="s1">&#39;sulc&#39;</span><span class="p">)]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="k">return</span> <span class="n">workflow</span></div>



<div class="viewcode-block" id="init_cortex_masks_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.surfaces.html#smriprep.workflows.surfaces.init_cortex_masks_wf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">init_cortex_masks_wf</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cortex_masks_wf&#39;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create cortical surface masks from surface files.</span>

<span class="sd">    Workflow Graph</span>
<span class="sd">        .. workflow::</span>
<span class="sd">            :graph2use: orig</span>
<span class="sd">            :simple_form: yes</span>

<span class="sd">            from smriprep.workflows.surfaces import init_cortex_masks_wf</span>
<span class="sd">            wf = init_cortex_masks_wf()</span>

<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    midthickness : len-2 list of str</span>
<span class="sd">        Each hemisphere&#39;s FreeSurfer midthickness surface file in GIFTI format</span>
<span class="sd">    thickness : len-2 list of str</span>
<span class="sd">        Each hemisphere&#39;s FreeSurfer thickness file in GIFTI format</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    cortex_masks : len-2 list of str</span>
<span class="sd">        Cortical surface mask in GIFTI format for each hemisphere</span>
<span class="sd">    source_files : len-2 list of lists of str</span>
<span class="sd">        Each hemisphere&#39;s source files, which are used to create the mask</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DEFAULT_MEMORY_MIN_GB</span> <span class="o">=</span> <span class="mf">0.01</span>

    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;thickness&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">itersource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hemi&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;itersource&#39;</span><span class="p">,</span>
        <span class="n">iterables</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;hemi&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">])],</span>
    <span class="p">)</span>

    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">JoinNode</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cortex_masks&#39;</span><span class="p">,</span> <span class="s1">&#39;source_files&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">,</span>
        <span class="n">joinsource</span><span class="o">=</span><span class="s1">&#39;itersource&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">select_surfaces</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">KeySelect</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;midthickness&#39;</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;select_surfaces&#39;</span><span class="p">,</span>
        <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">combine_sources</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;combine_sources&#39;</span><span class="p">,</span> <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">abs_thickness</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">MetricMath</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;abs_thickness&#39;</span><span class="p">,</span>
        <span class="n">mem_gb</span><span class="o">=</span><span class="n">DEFAULT_MEMORY_MIN_GB</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">initial_roi</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">MetricMath</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;roi&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;bin&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;initial_roi&#39;</span><span class="p">,</span> <span class="n">mem_gb</span><span class="o">=</span><span class="n">DEFAULT_MEMORY_MIN_GB</span>
    <span class="p">)</span>
    <span class="n">fill_holes</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">MetricFillHoles</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fill_holes&#39;</span><span class="p">,</span> <span class="n">mem_gb</span><span class="o">=</span><span class="n">DEFAULT_MEMORY_MIN_GB</span><span class="p">)</span>
    <span class="n">native_roi</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">MetricRemoveIslands</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;native_roi&#39;</span><span class="p">,</span> <span class="n">mem_gb</span><span class="o">=</span><span class="n">DEFAULT_MEMORY_MIN_GB</span><span class="p">)</span>

    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">select_surfaces</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;thickness&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;midthickness&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">itersource</span><span class="p">,</span> <span class="n">select_surfaces</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;hemi&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">itersource</span><span class="p">,</span> <span class="n">abs_thickness</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;hemi&#39;</span><span class="p">,</span> <span class="s1">&#39;hemisphere&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">itersource</span><span class="p">,</span> <span class="n">initial_roi</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;hemi&#39;</span><span class="p">,</span> <span class="s1">&#39;hemisphere&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">select_surfaces</span><span class="p">,</span> <span class="n">abs_thickness</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">select_surfaces</span><span class="p">,</span> <span class="n">fill_holes</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;surface_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">select_surfaces</span><span class="p">,</span> <span class="n">native_roi</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;surface_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">abs_thickness</span><span class="p">,</span> <span class="n">initial_roi</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;metric_file&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">initial_roi</span><span class="p">,</span> <span class="n">fill_holes</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;metric_file&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">fill_holes</span><span class="p">,</span> <span class="n">native_roi</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">native_roi</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;cortex_masks&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">select_surfaces</span><span class="p">,</span> <span class="n">combine_sources</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;in1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;in2&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">combine_sources</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;source_files&#39;</span><span class="p">)]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="k">return</span> <span class="n">workflow</span></div>



<div class="viewcode-block" id="init_segs_to_native_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.surfaces.html#smriprep.workflows.surfaces.init_segs_to_native_wf">[docs]</a>
<span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;anat.segs-to-anat&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_segs_to_native_wf</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">image_type</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;T2w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;T1w&#39;</span><span class="p">,</span>
    <span class="n">segmentation</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;aseg&#39;</span><span class="p">,</span> <span class="s1">&#39;aparc_aseg&#39;</span><span class="p">,</span> <span class="s1">&#39;aparc_a2009s&#39;</span><span class="p">,</span> <span class="s1">&#39;aparc_dkt&#39;</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;aseg&#39;</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;segs_to_native_wf&#39;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Workflow</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a segmentation from FreeSurfer conformed space into native anatomical space.</span>

<span class="sd">    Workflow Graph</span>
<span class="sd">        .. workflow::</span>
<span class="sd">            :graph2use: orig</span>
<span class="sd">            :simple_form: yes</span>

<span class="sd">            from smriprep.workflows.surfaces import init_segs_to_native_wf</span>
<span class="sd">            wf = init_segs_to_native_wf()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image_type</span>
<span class="sd">        MR anatomical image type (&#39;T1w&#39; or &#39;T2w&#39;)</span>
<span class="sd">    segmentation</span>
<span class="sd">        The name of a segmentation (&#39;aseg&#39; or &#39;aparc_aseg&#39; or &#39;wmparc&#39;)</span>

<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    in_file</span>
<span class="sd">        Anatomical, merged anatomical image after INU correction</span>
<span class="sd">    subjects_dir</span>
<span class="sd">        FreeSurfer SUBJECTS_DIR</span>
<span class="sd">    subject_id</span>
<span class="sd">        FreeSurfer subject ID</span>
<span class="sd">    fsnative2anat_xfm</span>
<span class="sd">        LTA-style affine matrix translating from FreeSurfer-conformed subject space to anatomical</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    out_file</span>
<span class="sd">        The selected segmentation, after resampling in native space</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">segmentation</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">([</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;fsnative2anat_xfm&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">([</span><span class="s1">&#39;out_file&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">)</span>
    <span class="c1"># Extract the aseg and aparc+aseg outputs</span>
    <span class="n">fssource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">FreeSurferSource</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fs_datasource&#39;</span><span class="p">)</span>

    <span class="n">lta</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">ConcatenateXFMs</span><span class="p">(</span><span class="n">out_fmt</span><span class="o">=</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lta&#39;</span><span class="p">,</span> <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Resample from Freesurfer anat to native anat, applying any offset in fsnative2anat_xfm,</span>
    <span class="c1"># and convert to NIfTI while we&#39;re at it</span>
    <span class="n">resample</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">fs</span><span class="o">.</span><span class="n">ApplyVolTransform</span><span class="p">(</span><span class="n">transformed_file</span><span class="o">=</span><span class="s1">&#39;seg.nii.gz&#39;</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;resample&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">select_seg</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">_select_seg</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;select_seg&#39;</span><span class="p">)</span>
    <span class="n">select_seg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">segmentation</span> <span class="o">=</span> <span class="n">segmentation</span>

    <span class="n">anat</span> <span class="o">=</span> <span class="s1">&#39;T2&#39;</span> <span class="k">if</span> <span class="n">image_type</span> <span class="o">==</span> <span class="s1">&#39;T2w&#39;</span> <span class="k">else</span> <span class="s1">&#39;T1&#39;</span>

    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">fssource</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">lta</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;fsnative2anat_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;in_xfms&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">fssource</span><span class="p">,</span> <span class="n">lta</span><span class="p">,</span> <span class="p">[(</span><span class="n">anat</span><span class="p">,</span> <span class="s1">&#39;moving&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">resample</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span> <span class="s1">&#39;target_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">fssource</span><span class="p">,</span> <span class="n">select_seg</span><span class="p">,</span> <span class="p">[(</span><span class="n">segmentation</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">select_seg</span><span class="p">,</span> <span class="n">resample</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;source_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">lta</span><span class="p">,</span> <span class="n">resample</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;lta_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">resample</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;transformed_file&#39;</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">)]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">return</span> <span class="n">workflow</span></div>



<div class="viewcode-block" id="init_anat_ribbon_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.surfaces.html#smriprep.workflows.surfaces.init_anat_ribbon_wf">[docs]</a>
<span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;anat.ribbon-mask&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_anat_ribbon_wf</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_ribbon_wf&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create anatomical ribbon mask</span>

<span class="sd">    Workflow Graph</span>

<span class="sd">        .. workflow::</span>
<span class="sd">            :graph2use: orig</span>
<span class="sd">            :simple_form: yes</span>

<span class="sd">            from smriprep.workflows.surfaces import init_anat_ribbon_wf</span>
<span class="sd">            wf = init_anat_ribbon_wf()</span>

<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    white</span>
<span class="sd">        Left and right gray/white surfaces (as GIFTI files)</span>
<span class="sd">    pial</span>
<span class="sd">        Left and right pial surfaces (as GIFTI files)</span>
<span class="sd">    ref_file</span>
<span class="sd">        Reference image (one 3D volume) to define the target space</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    anat_ribbon</span>
<span class="sd">        Cortical gray matter mask, sampled into ``ref_file`` space</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DEFAULT_MEMORY_MIN_GB</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">workflow</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;pial&#39;</span><span class="p">,</span> <span class="s1">&#39;ref_file&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;anat_ribbon&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">)</span>

    <span class="n">create_wm_distvol</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">CreateSignedDistanceVolume</span><span class="p">(),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;surf_file&#39;</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;create_wm_distvol&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">create_pial_distvol</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">CreateSignedDistanceVolume</span><span class="p">(),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;surf_file&#39;</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;create_pial_distvol&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">make_ribbon</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">MakeRibbon</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;make_ribbon&#39;</span><span class="p">,</span> <span class="n">mem_gb</span><span class="o">=</span><span class="n">DEFAULT_MEMORY_MIN_GB</span><span class="p">)</span>

    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">create_wm_distvol</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;surf_file&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ref_file&#39;</span><span class="p">,</span> <span class="s1">&#39;ref_file&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">create_pial_distvol</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;pial&#39;</span><span class="p">,</span> <span class="s1">&#39;surf_file&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ref_file&#39;</span><span class="p">,</span> <span class="s1">&#39;ref_file&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">create_wm_distvol</span><span class="p">,</span> <span class="n">make_ribbon</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;white_distvols&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">create_pial_distvol</span><span class="p">,</span> <span class="n">make_ribbon</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;pial_distvols&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">make_ribbon</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;ribbon&#39;</span><span class="p">,</span> <span class="s1">&#39;anat_ribbon&#39;</span><span class="p">)]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">return</span> <span class="n">workflow</span></div>



<div class="viewcode-block" id="init_resample_surfaces_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.surfaces.html#smriprep.workflows.surfaces.init_resample_surfaces_wf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">init_resample_surfaces_wf</span><span class="p">(</span>
    <span class="n">surfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;fsLR&#39;</span><span class="p">,</span>
    <span class="n">cohort</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">space</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s1">&#39;fsLR&#39;</span><span class="p">,</span>
    <span class="n">density</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">grayord_density</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;resample_surfaces_wf&#39;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resample subject surfaces surface to specified template space and density,</span>
<span class="sd">    using a given registration space.</span>

<span class="sd">    Workflow Graph</span>
<span class="sd">        .. workflow::</span>
<span class="sd">            :graph2use: colored</span>
<span class="sd">            :simple_form: yes</span>

<span class="sd">            from smriprep.workflows.surfaces import init_resample_surfaces_wf</span>
<span class="sd">            wf = init_resample_surfaces_wf(</span>
<span class="sd">                surfaces=[&#39;white&#39;, &#39;pial&#39;, &#39;midthickness&#39;],</span>
<span class="sd">                template=&#39;onavg&#39;,</span>
<span class="sd">                density=&#39;10k&#39;,</span>
<span class="sd">            )</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    surfaces : :class:`list` of :class:`str`</span>
<span class="sd">        Names of surfaces (e.g., ``&#39;white&#39;``) to resample. Both hemispheres will be resampled.</span>
<span class="sd">    template : :class:`str`</span>
<span class="sd">        The template space to resample to, e.g., ``&#39;onavg&#39;``, ``&#39;fsLR&#39;``.</span>
<span class="sd">    cohort : :class:`str` or :obj:`None`</span>
<span class="sd">        The template cohort to use, if the template provides multiple.</span>
<span class="sd">    space : :class:`str` or :obj:`None`</span>
<span class="sd">        The registration space for which there are both subject and template</span>
<span class="sd">        registration spheres.</span>
<span class="sd">        If ``None``, the template space is used.</span>
<span class="sd">    density : :class:`str`</span>
<span class="sd">        The density to resample to, e.g., ``&#39;10k&#39;``, ``&#39;41k&#39;``. Number of vertices per hemisphere.</span>
<span class="sd">    name : :class:`str`</span>
<span class="sd">        Unique name for the subworkflow (default: ``&quot;resample_surfaces_wf&quot;``)</span>

<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    ``&lt;surface&gt;``</span>
<span class="sd">        Left and right GIFTIs for each surface name passed to ``surfaces``.</span>
<span class="sd">    ``sphere_reg_&lt;space&gt;``</span>
<span class="sd">        GIFTI surface mesh corresponding to the subject&#39;s registration sphere to ``space``.</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    ``&lt;surface&gt;_&lt;template&gt;``</span>
<span class="sd">        Left and right GIFTI surface mesh corresponding to the input surface, resampled to the</span>
<span class="sd">        specified space and density.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">templateflow.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.engine.workflows</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiterateWorkflow</span> <span class="k">as</span> <span class="n">Workflow</span>

    <span class="k">if</span> <span class="n">density</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">grayord_density</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No density specified. Set density argument.&#39;</span><span class="p">)</span>
        <span class="n">density</span> <span class="o">=</span> <span class="s1">&#39;32k&#39;</span> <span class="k">if</span> <span class="n">grayord_density</span> <span class="o">==</span> <span class="s1">&#39;91k&#39;</span> <span class="k">else</span> <span class="s1">&#39;59k&#39;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s1">&#39;Deprecated grayord_density passed. Replace with</span><span class="se">\n\t</span><span class="s1">&#39;</span>
            <span class="s2">&quot;density=&#39;32k&#39; if grayord_density == &#39;91k&#39; else &#39;59k&#39;&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="n">surfaces</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sphere_reg_</span><span class="si">{</span><span class="n">space</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">surf</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">template</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">surf</span> <span class="ow">in</span> <span class="n">surfaces</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">surface_list</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">surfaces</span><span class="p">),</span> <span class="n">ravel_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;surface_list&#39;</span><span class="p">,</span>
        <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">resampler</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">SurfaceResample</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;BARYCENTRIC&#39;</span><span class="p">),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;surface_in&#39;</span><span class="p">,</span> <span class="s1">&#39;current_sphere&#39;</span><span class="p">,</span> <span class="s1">&#39;new_sphere&#39;</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;resampler&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">resampler</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">new_sphere</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">str</span><span class="p">(</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
                <span class="n">cohort</span><span class="o">=</span><span class="n">cohort</span><span class="p">,</span>
                <span class="n">space</span><span class="o">=</span><span class="n">space</span> <span class="k">if</span> <span class="n">space</span> <span class="o">!=</span> <span class="n">template</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">hemi</span><span class="o">=</span><span class="n">hemi</span><span class="p">,</span>
                <span class="n">density</span><span class="o">=</span><span class="n">density</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;sphere&#39;</span><span class="p">,</span>
                <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;.surf.gii&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Order matters. Iterate over surfaces, then hemis to get L R L R L R</span>
        <span class="k">for</span> <span class="n">_surf</span> <span class="ow">in</span> <span class="n">surfaces</span>
        <span class="k">for</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="n">surface_groups</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">splits</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">surfaces</span><span class="p">)),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;surface_groups&#39;</span><span class="p">,</span>
        <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">surface_list</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">((</span><span class="n">surf</span><span class="p">,</span> <span class="n">_sorted_by_basename</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;in</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">surf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">surfaces</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">resampler</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">((</span><span class="sa">f</span><span class="s1">&#39;sphere_reg_</span><span class="si">{</span><span class="n">space</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">_repeat</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">surfaces</span><span class="p">)),</span> <span class="s1">&#39;current_sphere&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">surface_list</span><span class="p">,</span> <span class="n">resampler</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;surface_in&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">resampler</span><span class="p">,</span> <span class="n">surface_groups</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;surface_out&#39;</span><span class="p">,</span> <span class="s1">&#39;inlist&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">surface_groups</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;out</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">surf</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">template</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">surf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">surfaces</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="k">return</span> <span class="n">workflow</span></div>



<div class="viewcode-block" id="init_morph_grayords_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.surfaces.html#smriprep.workflows.surfaces.init_morph_grayords_wf">[docs]</a>
<span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;anat.resample-morphs-grayords&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_morph_grayords_wf</span><span class="p">(</span>
    <span class="n">grayord_density</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;91k&#39;</span><span class="p">,</span> <span class="s1">&#39;170k&#39;</span><span class="p">],</span>
    <span class="n">omp_nthreads</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;morph_grayords_wf&#39;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sample Grayordinates files onto the fsLR atlas.</span>

<span class="sd">    Outputs are in CIFTI2 format.</span>

<span class="sd">    Workflow Graph</span>
<span class="sd">        .. workflow::</span>
<span class="sd">            :graph2use: colored</span>
<span class="sd">            :simple_form: yes</span>

<span class="sd">            from smriprep.workflows.surfaces import init_morph_grayords_wf</span>
<span class="sd">            wf = init_morph_grayords_wf(grayord_density=&quot;91k&quot;, omp_nthreads=1)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grayord_density : :obj:`str`</span>
<span class="sd">        Either `91k` or `170k`, representing the total of vertices or *grayordinates*.</span>
<span class="sd">    name : :obj:`str`</span>
<span class="sd">        Unique name for the subworkflow (default: ``&quot;morph_grayords_wf&quot;``)</span>

<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    curv</span>
<span class="sd">        HCP-style curvature file in GIFTI format</span>
<span class="sd">    sulc</span>
<span class="sd">        HCP-style sulcal depth file in GIFTI format</span>
<span class="sd">    thickness</span>
<span class="sd">        HCP-style thickness file in GIFTI format</span>
<span class="sd">    roi</span>
<span class="sd">        HCP-style cortical ROI file in GIFTI format</span>
<span class="sd">    midthickness</span>
<span class="sd">        GIFTI surface mesh corresponding to the midthickness surface</span>
<span class="sd">    sphere_reg_fsLR</span>
<span class="sd">        GIFTI surface mesh corresponding to the subject&#39;s fsLR registration sphere</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    curv_fsLR</span>
<span class="sd">        HCP-style curvature file in CIFTI-2 format, resampled to fsLR</span>
<span class="sd">    curv_metadata</span>
<span class="sd">        Path to JSON file containing metadata corresponding to ``curv_fsLR``</span>
<span class="sd">    sulc_fsLR</span>
<span class="sd">        HCP-style sulcal depth file in CIFTI-2 format, resampled to fsLR</span>
<span class="sd">    sulc_metadata</span>
<span class="sd">        Path to JSON file containing metadata corresponding to ``sulc_fsLR``</span>
<span class="sd">    thickness_fsLR</span>
<span class="sd">        HCP-style thickness file in CIFTI-2 format, resampled to fsLR</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">templateflow.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.engine.workflows</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiterateWorkflow</span> <span class="k">as</span> <span class="n">Workflow</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">smriprep.interfaces.cifti</span><span class="w"> </span><span class="kn">import</span> <span class="n">GenerateDScalar</span>

    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="n">workflow</span><span class="o">.</span><span class="n">__desc__</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">*Grayordinate* &quot;dscalar&quot; files containing </span><span class="si">{</span><span class="n">grayord_density</span><span class="si">}</span><span class="s2"> samples were</span>
<span class="s2">resampled onto fsLR using the Connectome Workbench [@hcppipelines].</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="n">fslr_density</span> <span class="o">=</span> <span class="s1">&#39;32k&#39;</span> <span class="k">if</span> <span class="n">grayord_density</span> <span class="o">==</span> <span class="s1">&#39;91k&#39;</span> <span class="k">else</span> <span class="s1">&#39;59k&#39;</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;curv&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sulc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;thickness&#39;</span><span class="p">,</span>
                <span class="s1">&#39;roi&#39;</span><span class="p">,</span>
                <span class="s1">&#39;midthickness&#39;</span><span class="p">,</span>
                <span class="s1">&#39;midthickness_fsLR&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Note we have to use a different name than itersource to</span>
    <span class="c1"># avoid duplicates in the workflow graph, even though the</span>
    <span class="c1"># previous was already Joined</span>
    <span class="n">hemisource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hemi&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;hemisource&#39;</span><span class="p">,</span>
        <span class="n">iterables</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;hemi&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">])],</span>
    <span class="p">)</span>

    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;curv_fsLR&#39;</span><span class="p">,</span>
                <span class="s1">&#39;curv_metadata&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sulc_fsLR&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sulc_metadata&#39;</span><span class="p">,</span>
                <span class="s1">&#39;thickness_fsLR&#39;</span><span class="p">,</span>
                <span class="s1">&#39;thickness_metadata&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">atlases</span> <span class="o">=</span> <span class="n">smriprep</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;atlases&#39;</span><span class="p">)</span>
    <span class="n">select_surfaces</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">KeySelect</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;curv&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sulc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;thickness&#39;</span><span class="p">,</span>
                <span class="s1">&#39;roi&#39;</span><span class="p">,</span>
                <span class="s1">&#39;midthickness&#39;</span><span class="p">,</span>
                <span class="s1">&#39;midthickness_fsLR&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">,</span>
                <span class="s1">&#39;template_sphere&#39;</span><span class="p">,</span>
                <span class="s1">&#39;template_roi&#39;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;select_surfaces&#39;</span><span class="p">,</span>
        <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">select_surfaces</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template_sphere</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">str</span><span class="p">(</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">template</span><span class="o">=</span><span class="s1">&#39;fsLR&#39;</span><span class="p">,</span>
                <span class="n">density</span><span class="o">=</span><span class="n">fslr_density</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;sphere&#39;</span><span class="p">,</span>
                <span class="n">hemi</span><span class="o">=</span><span class="n">hemi</span><span class="p">,</span>
                <span class="n">space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;.surf.gii&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">select_surfaces</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template_roi</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">atlases</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;L.atlasroi.</span><span class="si">{</span><span class="n">fslr_density</span><span class="si">}</span><span class="s1">_fs_LR.shape.gii&#39;</span><span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">atlases</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;R.atlasroi.</span><span class="si">{</span><span class="n">fslr_density</span><span class="si">}</span><span class="s1">_fs_LR.shape.gii&#39;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">select_surfaces</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;curv&#39;</span><span class="p">,</span> <span class="s1">&#39;curv&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;sulc&#39;</span><span class="p">,</span> <span class="s1">&#39;sulc&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;thickness&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;roi&#39;</span><span class="p">,</span> <span class="s1">&#39;roi&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;midthickness&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;midthickness_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;midthickness_fsLR&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">hemisource</span><span class="p">,</span> <span class="n">select_surfaces</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;hemi&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">)]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;curv&#39;</span><span class="p">,</span> <span class="s1">&#39;sulc&#39;</span><span class="p">,</span> <span class="s1">&#39;thickness&#39;</span><span class="p">):</span>
        <span class="n">resampler</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
            <span class="n">MetricResample</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ADAP_BARY_AREA&#39;</span><span class="p">,</span> <span class="n">area_surfs</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;resample_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">n_procs</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mask_fsLR</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
            <span class="n">MetricMask</span><span class="p">(),</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;mask_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">n_procs</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">cifti_metric</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">JoinNode</span><span class="p">(</span>
            <span class="n">GenerateDScalar</span><span class="p">(</span><span class="n">grayordinates</span><span class="o">=</span><span class="n">grayord_density</span><span class="p">,</span> <span class="n">scalar_name</span><span class="o">=</span><span class="n">metric</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;cifti_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">joinfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;scalar_surfs&#39;</span><span class="p">],</span>
            <span class="n">joinsource</span><span class="o">=</span><span class="s1">&#39;hemisource&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">select_surfaces</span><span class="p">,</span> <span class="n">resampler</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;current_sphere&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;template_sphere&#39;</span><span class="p">,</span> <span class="s1">&#39;new_sphere&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;current_area&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;midthickness_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;new_area&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;roi&#39;</span><span class="p">,</span> <span class="s1">&#39;roi_metric&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">select_surfaces</span><span class="p">,</span> <span class="n">mask_fsLR</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;template_roi&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">resampler</span><span class="p">,</span> <span class="n">mask_fsLR</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">mask_fsLR</span><span class="p">,</span> <span class="n">cifti_metric</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;scalar_surfs&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">cifti_metric</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">_fsLR&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;out_metadata&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">_metadata&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="k">return</span> <span class="n">workflow</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_check_cw256</span><span class="p">(</span><span class="n">in_files</span><span class="p">,</span> <span class="n">default_flags</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">nibabel.funcs</span><span class="w"> </span><span class="kn">import</span> <span class="n">concat_images</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">in_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">in_files</span><span class="p">]</span>
    <span class="n">summary_img</span> <span class="o">=</span> <span class="n">concat_images</span><span class="p">(</span><span class="n">in_files</span><span class="p">)</span>
    <span class="n">fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">summary_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">summary_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">default_flags</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">fov</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">):</span>
        <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-cw256&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flags</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_sorted_by_basename</span><span class="p">(</span><span class="n">inlist</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">os.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">basename</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">inlist</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_extract_fs_fields</span><span class="p">(</span><span class="n">filenames</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">filenames</span><span class="p">]</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">]</span>
    <span class="n">sub_dir</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
    <span class="n">subjects_dir</span><span class="p">,</span> <span class="n">subject_id</span> <span class="o">=</span> <span class="n">sub_dir</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">sub_dir</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected surface files from one subject.</span><span class="se">\n</span><span class="s1">Received: </span><span class="si">{</span><span class="n">filenames</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">subjects_dir</span><span class="p">),</span> <span class="n">subject_id</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_surfaces</span><span class="p">(</span><span class="n">subjects_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subject_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">surfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a list of FreeSurfer surface files for a given subject.</span>

<span class="sd">    If ``midthickness`` is requested but not present in the directory,</span>
<span class="sd">    ``graymid`` will be returned instead. For surfaces with dots (``.``) in</span>
<span class="sd">    their names, pass the name with underscores (``_``).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    subjects_dir</span>
<span class="sd">        FreeSurfer SUBJECTS_DIR</span>
<span class="sd">    subject_id</span>
<span class="sd">        FreeSurfer subject ID</span>
<span class="sd">    surfaces</span>
<span class="sd">        List of surfaces to fetch</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        A list of surfaces for each requested surface, sorted</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

    <span class="n">expanded_surfaces</span> <span class="o">=</span> <span class="n">surfaces</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;midthickness&#39;</span> <span class="ow">in</span> <span class="n">surfaces</span><span class="p">:</span>
        <span class="n">expanded_surfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;graymid&#39;</span><span class="p">)</span>

    <span class="n">surf_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">subjects_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">subject_id</span> <span class="o">/</span> <span class="s1">&#39;surf&#39;</span>
    <span class="n">all_surfs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">surface</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">surf_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[lr]h.</span><span class="si">{</span><span class="n">surface</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">surface</span> <span class="ow">in</span> <span class="n">expanded_surfaces</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">all_surfs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;graymid&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">all_surfs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;midthickness&#39;</span><span class="p">):</span>
        <span class="n">all_surfs</span><span class="p">[</span><span class="s1">&#39;midthickness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_surfs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;graymid&#39;</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">all_surfs</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span> <span class="k">for</span> <span class="n">surface</span> <span class="ow">in</span> <span class="n">surfaces</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_select_seg</span><span class="p">(</span><span class="n">in_files</span><span class="p">,</span> <span class="n">segmentation</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">in_files</span>

    <span class="n">seg_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;aparc_aseg&#39;</span><span class="p">:</span> <span class="s1">&#39;aparc+&#39;</span><span class="p">,</span> <span class="s1">&#39;aparc_a2009s&#39;</span><span class="p">:</span> <span class="s1">&#39;a2009s+&#39;</span><span class="p">,</span> <span class="s1">&#39;aparc_dkt&#39;</span><span class="p">:</span> <span class="s1">&#39;DKTatlas+&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">segmentation</span> <span class="ow">in</span> <span class="n">seg_mapping</span><span class="p">:</span>
        <span class="n">segmentation</span> <span class="o">=</span> <span class="n">seg_mapping</span><span class="p">[</span><span class="n">segmentation</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">in_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">segmentation</span> <span class="ow">in</span> <span class="n">fl</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fl</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No segmentation containing &quot;</span><span class="si">{</span><span class="n">segmentation</span><span class="si">}</span><span class="s1">&quot; was found.&#39;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_repeat</span><span class="p">(</span><span class="n">seq</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">seq</span> <span class="o">*</span> <span class="n">count</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Copyright 2019, Center for Reproducible Neuroscience, Stanford University.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: fix/tfselect-resless
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Tags</dt>
            <dd><a href="../../../../0.10.0/index.html">0.10.0</a></dd>
            <dd><a href="../../../../0.11.0/index.html">0.11.0</a></dd>
            <dd><a href="../../../../0.11.0rc0/index.html">0.11.0rc0</a></dd>
            <dd><a href="../../../../0.11.0rc1/index.html">0.11.0rc1</a></dd>
            <dd><a href="../../../../0.11.1/index.html">0.11.1</a></dd>
            <dd><a href="../../../../0.12.0/index.html">0.12.0</a></dd>
            <dd><a href="../../../../0.12.1/index.html">0.12.1</a></dd>
            <dd><a href="../../../../0.12.2/index.html">0.12.2</a></dd>
            <dd><a href="../../../../0.13.0/index.html">0.13.0</a></dd>
            <dd><a href="../../../../0.13.1/index.html">0.13.1</a></dd>
            <dd><a href="../../../../0.13.2/index.html">0.13.2</a></dd>
            <dd><a href="../../../../0.14.0/index.html">0.14.0</a></dd>
            <dd><a href="../../../../0.15.0/index.html">0.15.0</a></dd>
            <dd><a href="../../../../0.16.0/index.html">0.16.0</a></dd>
            <dd><a href="../../../../0.16.1/index.html">0.16.1</a></dd>
            <dd><a href="../../../../0.17.0/index.html">0.17.0</a></dd>
            <dd><a href="../../../../0.18.0/index.html">0.18.0</a></dd>
            <dd><a href="../../../../0.8.0/index.html">0.8.0</a></dd>
            <dd><a href="../../../../0.8.0rc1/index.html">0.8.0rc1</a></dd>
            <dd><a href="../../../../0.8.0rc2/index.html">0.8.0rc2</a></dd>
            <dd><a href="../../../../0.8.0rc3/index.html">0.8.0rc3</a></dd>
            <dd><a href="../../../../0.8.1/index.html">0.8.1</a></dd>
            <dd><a href="../../../../0.8.2/index.html">0.8.2</a></dd>
            <dd><a href="../../../../0.8.3/index.html">0.8.3</a></dd>
            <dd><a href="../../../../0.9.0/index.html">0.9.0</a></dd>
            <dd><a href="../../../../0.9.1/index.html">0.9.1</a></dd>
            <dd><a href="../../../../0.9.2/index.html">0.9.2</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../../dev-nibabies/index.html">dev-nibabies</a></dd>
            <dd><a href="../../../../enh_calabel/index.html">enh/calabel</a></dd>
            <dd><a href="../../../../enh_split-surfaces/index.html">enh/split-surfaces</a></dd>
            <dd><a href="../../../../fix_parcstats/index.html">fix/parcstats</a></dd>
            <dd><a href="../../../../fix_recon-report/index.html">fix/recon-report</a></dd>
            <dd><a href="surfaces.html">fix/tfselect-resless</a></dd>
            <dd><a href="../../../../maint_0.12.x/index.html">maint/0.12.x</a></dd>
            <dd><a href="../../../../maint_0.13.x/index.html">maint/0.13.x</a></dd>
            <dd><a href="../../../../maint_0.15.x/index.html">maint/0.15.x</a></dd>
            <dd><a href="../../../../maint_0.16.x/index.html">maint/0.16.x</a></dd>
            <dd><a href="../../../../maint_0.17.x/index.html">maint/0.17.x</a></dd>
            <dd><a href="../../../../maint_0.18.x/index.html">maint/0.18.x</a></dd>
            <dd><a href="../../../../maint_0.8.x/index.html">maint/0.8.x</a></dd>
            <dd><a href="../../../../maint_0.9.x/index.html">maint/0.9.x</a></dd>
            <dd><a href="../../../../master/index.html">master</a></dd>
            <dd><a href="../../../../rel_0.16.1/index.html">rel/0.16.1</a></dd>
            <dd><a href="../../../../rel_0.8.0rc1/index.html">rel/0.8.0rc1</a></dd>
        </dl>
    </div>
</div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
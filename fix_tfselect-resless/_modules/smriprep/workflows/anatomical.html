

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>smriprep.workflows.anatomical &mdash; smriprep 0.18.1.dev76 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5dd5ad26" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/banner.css?v=fd51b7f5" />

  
      <script src="../../../_static/jquery.js?v=1413ff29"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=7b397ac5"></script>
      <script src="../../../_static/doctools.js?v=6afcdcd2"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            smriprep
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">Library API (application program interface)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changes.html">Whatâ€™s new?</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">smriprep</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">smriprep.workflows.anatomical</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  


    
    



    <p class="scv-banner scv-sphinx_rtd_theme"><b>Warning:</b> This document is for the development version of smriprep.</p>
<h1>Source code for smriprep.workflows.anatomical</h1><div class="highlight"><pre>
<span></span><span class="c1"># emacs: -*- mode: python; py-indent-offset: 4; indent-tabs-mode: nil -*-</span>
<span class="c1"># vi: set ft=python sts=4 ts=4 sw=4 et:</span>
<span class="c1">#</span>
<span class="c1"># Copyright 2021 The NiPreps Developers &lt;nipreps@gmail.com&gt;</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>
<span class="c1"># We support and encourage derived works from this project, please read</span>
<span class="c1"># about our expectations at</span>
<span class="c1">#</span>
<span class="c1">#     https://www.nipreps.org/community/licensing/</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Anatomical reference preprocessing workflows.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ty</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">nipype</span><span class="w"> </span><span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nipype.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">freesurfer</span> <span class="k">as</span> <span class="n">fs</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nipype.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">fsl</span><span class="p">,</span>
    <span class="n">image</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nipype.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">utility</span> <span class="k">as</span> <span class="n">niu</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nipype.interfaces.ants</span><span class="w"> </span><span class="kn">import</span> <span class="n">DenoiseImage</span><span class="p">,</span> <span class="n">N4BiasFieldCorrection</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nipype.interfaces.ants.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Info</span> <span class="k">as</span> <span class="n">ANTsInfo</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nipype.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">engine</span> <span class="k">as</span> <span class="n">pe</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.anat.ants</span><span class="w"> </span><span class="kn">import</span> <span class="n">init_brain_extraction_wf</span><span class="p">,</span> <span class="n">init_n4_only_wf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Workflow</span><span class="p">,</span> <span class="n">tag</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.interfaces.fixes</span><span class="w"> </span><span class="kn">import</span> <span class="n">FixHeaderApplyTransforms</span> <span class="k">as</span> <span class="n">ApplyTransforms</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.interfaces.freesurfer</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">PatchedLTAConvert</span> <span class="k">as</span> <span class="n">LTAConvert</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.interfaces.freesurfer</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">StructuralReference</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.interfaces.header</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidateImage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.interfaces.images</span><span class="w"> </span><span class="kn">import</span> <span class="n">Conform</span><span class="p">,</span> <span class="n">TemplateDimensions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.interfaces.nibabel</span><span class="w"> </span><span class="kn">import</span> <span class="n">ApplyMask</span><span class="p">,</span> <span class="n">Binarize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.interfaces.nitransforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConcatenateXFMs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.utils.misc</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_suffix</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">niworkflows.utils.spaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">Reference</span><span class="p">,</span> <span class="n">SpatialReferences</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">smriprep</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">DerivativesDataSink</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..interfaces.fsl</span><span class="w"> </span><span class="kn">import</span> <span class="n">FAST</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.misc</span><span class="w"> </span><span class="kn">import</span> <span class="n">apply_lut</span> <span class="k">as</span> <span class="n">_apply_bids_lut</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.misc</span><span class="w"> </span><span class="kn">import</span> <span class="n">fs_isRunning</span> <span class="k">as</span> <span class="n">_fs_isRunning</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.fit.registration</span><span class="w"> </span><span class="kn">import</span> <span class="n">init_register_template_wf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.outputs</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">init_anat_reports_wf</span><span class="p">,</span>
    <span class="n">init_ds_anat_volumes_wf</span><span class="p">,</span>
    <span class="n">init_ds_dseg_wf</span><span class="p">,</span>
    <span class="n">init_ds_fs_registration_wf</span><span class="p">,</span>
    <span class="n">init_ds_fs_segs_wf</span><span class="p">,</span>
    <span class="n">init_ds_grayord_metrics_wf</span><span class="p">,</span>
    <span class="n">init_ds_mask_wf</span><span class="p">,</span>
    <span class="n">init_ds_surface_masks_wf</span><span class="p">,</span>
    <span class="n">init_ds_surface_metrics_wf</span><span class="p">,</span>
    <span class="n">init_ds_surfaces_wf</span><span class="p">,</span>
    <span class="n">init_ds_template_registration_wf</span><span class="p">,</span>
    <span class="n">init_ds_template_wf</span><span class="p">,</span>
    <span class="n">init_ds_tpms_wf</span><span class="p">,</span>
    <span class="n">init_template_iterator_wf</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.surfaces</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">init_anat_ribbon_wf</span><span class="p">,</span>
    <span class="n">init_cortex_masks_wf</span><span class="p">,</span>
    <span class="n">init_fsLR_reg_wf</span><span class="p">,</span>
    <span class="n">init_gifti_morphometrics_wf</span><span class="p">,</span>
    <span class="n">init_gifti_surfaces_wf</span><span class="p">,</span>
    <span class="n">init_hcp_morphometrics_wf</span><span class="p">,</span>
    <span class="n">init_morph_grayords_wf</span><span class="p">,</span>
    <span class="n">init_msm_sulc_wf</span><span class="p">,</span>
    <span class="n">init_refinement_wf</span><span class="p">,</span>
    <span class="n">init_resample_surfaces_wf</span><span class="p">,</span>
    <span class="n">init_surface_derivatives_wf</span><span class="p">,</span>
    <span class="n">init_surface_recon_wf</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;nipype.workflow&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="init_anat_preproc_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.anatomical.html#smriprep.workflows.anatomical.init_anat_preproc_wf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">init_anat_preproc_wf</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">bids_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">freesurfer</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">hires</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">longitudinal</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">msm_sulc</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">t1w</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">t2w</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">skull_strip_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">skull_strip_template</span><span class="p">:</span> <span class="n">Reference</span><span class="p">,</span>
    <span class="n">spaces</span><span class="p">:</span> <span class="n">SpatialReferences</span><span class="p">,</span>
    <span class="n">precomputed</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">omp_nthreads</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">flair</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">(),</span>  <span class="c1"># Remove default after callers start passing it</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">sloppy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cifti_output</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;91k&#39;</span><span class="p">,</span> <span class="s1">&#39;170k&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;anat_preproc_wf&#39;</span><span class="p">,</span>
    <span class="n">skull_strip_fixed_seed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">fs_no_resume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stage the anatomical preprocessing steps of *sMRIPrep*.</span>

<span class="sd">    This workflow is a compatibility wrapper around :py:func:`init_anat_fit_wf`</span>
<span class="sd">    that emits all derivatives that were present in sMRIPrep 0.9.x and before.</span>

<span class="sd">    Workflow Graph</span>
<span class="sd">        .. workflow::</span>
<span class="sd">            :graph2use: orig</span>
<span class="sd">            :simple_form: yes</span>

<span class="sd">            from niworkflows.utils.spaces import SpatialReferences, Reference</span>
<span class="sd">            from smriprep.workflows.anatomical import init_anat_preproc_wf</span>
<span class="sd">            spaces = SpatialReferences(spaces=[&#39;MNI152NLin2009cAsym&#39;, &#39;fsaverage5&#39;])</span>
<span class="sd">            spaces.checkpoint()</span>
<span class="sd">            wf = init_anat_preproc_wf(</span>
<span class="sd">                bids_root=&#39;.&#39;,</span>
<span class="sd">                output_dir=&#39;.&#39;,</span>
<span class="sd">                freesurfer=True,</span>
<span class="sd">                hires=True,</span>
<span class="sd">                longitudinal=False,</span>
<span class="sd">                msm_sulc=False,</span>
<span class="sd">                t1w=[&#39;t1w.nii.gz&#39;],</span>
<span class="sd">                t2w=[],</span>
<span class="sd">                skull_strip_mode=&#39;force&#39;,</span>
<span class="sd">                skull_strip_template=Reference(&#39;OASIS30ANTs&#39;),</span>
<span class="sd">                spaces=spaces,</span>
<span class="sd">                precomputed={},</span>
<span class="sd">                omp_nthreads=1,</span>
<span class="sd">            )</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bids_root : :obj:`str`</span>
<span class="sd">        Path of the input BIDS dataset root</span>
<span class="sd">    output_dir : :obj:`str`</span>
<span class="sd">        Directory in which to save derivatives</span>
<span class="sd">    freesurfer : :obj:`bool`</span>
<span class="sd">        Enable FreeSurfer surface reconstruction (increases runtime by 6h,</span>
<span class="sd">        at the very least)</span>
<span class="sd">    hires : :obj:`bool`</span>
<span class="sd">        Enable sub-millimeter preprocessing in FreeSurfer</span>
<span class="sd">    longitudinal : :obj:`bool`</span>
<span class="sd">        Create unbiased structural template, regardless of number of inputs</span>
<span class="sd">        (may increase runtime)</span>
<span class="sd">    t1w : :obj:`list`</span>
<span class="sd">        List of T1-weighted structural images.</span>
<span class="sd">    skull_strip_mode : :obj:`str`</span>
<span class="sd">        Determiner for T1-weighted skull stripping (`force` ensures skull stripping,</span>
<span class="sd">        `skip` ignores skull stripping, and `auto` automatically ignores skull stripping</span>
<span class="sd">        if pre-stripped brains are detected).</span>
<span class="sd">    skull_strip_template : :py:class:`~niworkflows.utils.spaces.Reference`</span>
<span class="sd">        Spatial reference to use in atlas-based brain extraction.</span>
<span class="sd">    spaces : :py:class:`~niworkflows.utils.spaces.SpatialReferences`</span>
<span class="sd">        Object containing standard and nonstandard space specifications.</span>
<span class="sd">    precomputed : :obj:`dict`</span>
<span class="sd">        Dictionary mapping output specification attribute names and</span>
<span class="sd">        paths to precomputed derivatives.</span>
<span class="sd">    omp_nthreads : :obj:`int`</span>
<span class="sd">        Maximum number of threads an individual process may use</span>
<span class="sd">    debug : :obj:`bool`</span>
<span class="sd">        Enable debugging outputs</span>
<span class="sd">    sloppy: :obj:`bool`</span>
<span class="sd">        Quick, impercise operations. Used to decrease workflow duration.</span>
<span class="sd">    name : :obj:`str`, optional</span>
<span class="sd">        Workflow name (default: anat_fit_wf)</span>
<span class="sd">    skull_strip_fixed_seed : :obj:`bool`</span>
<span class="sd">        Do not use a random seed for skull-stripping - will ensure</span>
<span class="sd">        run-to-run replicability when used with --omp-nthreads 1</span>
<span class="sd">        (default: ``False``).</span>
<span class="sd">    fs_no_resume : bool</span>
<span class="sd">        EXPERT: Import pre-computed FreeSurfer reconstruction without resuming.</span>
<span class="sd">        The user is responsible for ensuring that all necessary files are present.</span>
<span class="sd">        (default: ``False``).</span>

<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    t1w</span>
<span class="sd">        List of T1-weighted structural images</span>
<span class="sd">    t2w</span>
<span class="sd">        List of T2-weighted structural images</span>
<span class="sd">    roi</span>
<span class="sd">        A mask to exclude regions during standardization</span>
<span class="sd">    flair</span>
<span class="sd">        List of FLAIR images</span>
<span class="sd">    subjects_dir</span>
<span class="sd">        FreeSurfer SUBJECTS_DIR</span>
<span class="sd">    subject_id</span>
<span class="sd">        FreeSurfer subject ID</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    t1w_preproc</span>
<span class="sd">        The T1w reference map, which is calculated as the average of bias-corrected</span>
<span class="sd">        and preprocessed T1w images, defining the anatomical space.</span>
<span class="sd">    t1w_mask</span>
<span class="sd">        Brain (binary) mask estimated by brain extraction.</span>
<span class="sd">    t1w_dseg</span>
<span class="sd">        Brain tissue segmentation of the preprocessed structural image, including</span>
<span class="sd">        gray-matter (GM), white-matter (WM) and cerebrospinal fluid (CSF).</span>
<span class="sd">    t1w_tpms</span>
<span class="sd">        List of tissue probability maps corresponding to ``t1w_dseg``.</span>
<span class="sd">    template</span>
<span class="sd">        List of template names to which the structural image has been registered</span>
<span class="sd">    anat2std_xfm</span>
<span class="sd">        List of nonlinear spatial transforms to resample data from subject</span>
<span class="sd">        anatomical space into standard template spaces. Collated with template.</span>
<span class="sd">    std2anat_xfm</span>
<span class="sd">        List of nonlinear spatial transforms to resample data from standard</span>
<span class="sd">        template spaces into subject anatomical space. Collated with template.</span>
<span class="sd">    subjects_dir</span>
<span class="sd">        FreeSurfer SUBJECTS_DIR; use as input to a node to ensure that it is run after</span>
<span class="sd">        FreeSurfer reconstruction is completed.</span>
<span class="sd">    subject_id</span>
<span class="sd">        FreeSurfer subject ID; use as input to a node to ensure that it is run after</span>
<span class="sd">        FreeSurfer reconstruction is completed.</span>
<span class="sd">    fsnative2t1w_xfm</span>
<span class="sd">        ITK-style affine matrix translating from FreeSurfer-conformed subject space to T1w</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;t1w&#39;</span><span class="p">,</span> <span class="s1">&#39;t2w&#39;</span><span class="p">,</span> <span class="s1">&#39;roi&#39;</span><span class="p">,</span> <span class="s1">&#39;flair&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;template&#39;</span><span class="p">,</span>
                <span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span>
                <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span>
                <span class="s1">&#39;t1w_preproc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;t1w_mask&#39;</span><span class="p">,</span>
                <span class="s1">&#39;t1w_dseg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;t1w_tpms&#39;</span><span class="p">,</span>
                <span class="s1">&#39;anat2std_xfm&#39;</span><span class="p">,</span>
                <span class="s1">&#39;std2anat_xfm&#39;</span><span class="p">,</span>
                <span class="s1">&#39;fsnative2t1w_xfm&#39;</span><span class="p">,</span>
                <span class="s1">&#39;t1w_aparc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;t1w_aseg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sphere_reg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">anat_fit_wf</span> <span class="o">=</span> <span class="n">init_anat_fit_wf</span><span class="p">(</span>
        <span class="n">bids_root</span><span class="o">=</span><span class="n">bids_root</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
        <span class="n">freesurfer</span><span class="o">=</span><span class="n">freesurfer</span><span class="p">,</span>
        <span class="n">hires</span><span class="o">=</span><span class="n">hires</span><span class="p">,</span>
        <span class="n">longitudinal</span><span class="o">=</span><span class="n">longitudinal</span><span class="p">,</span>
        <span class="n">msm_sulc</span><span class="o">=</span><span class="n">msm_sulc</span><span class="p">,</span>
        <span class="n">skull_strip_mode</span><span class="o">=</span><span class="n">skull_strip_mode</span><span class="p">,</span>
        <span class="n">skull_strip_template</span><span class="o">=</span><span class="n">skull_strip_template</span><span class="p">,</span>
        <span class="n">spaces</span><span class="o">=</span><span class="n">spaces</span><span class="p">,</span>
        <span class="n">t1w</span><span class="o">=</span><span class="n">t1w</span><span class="p">,</span>
        <span class="n">t2w</span><span class="o">=</span><span class="n">t2w</span><span class="p">,</span>
        <span class="n">flair</span><span class="o">=</span><span class="n">flair</span><span class="p">,</span>
        <span class="n">precomputed</span><span class="o">=</span><span class="n">precomputed</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
        <span class="n">sloppy</span><span class="o">=</span><span class="n">sloppy</span><span class="p">,</span>
        <span class="n">omp_nthreads</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
        <span class="n">skull_strip_fixed_seed</span><span class="o">=</span><span class="n">skull_strip_fixed_seed</span><span class="p">,</span>
        <span class="n">fs_no_resume</span><span class="o">=</span><span class="n">fs_no_resume</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">template_iterator_wf</span> <span class="o">=</span> <span class="n">init_template_iterator_wf</span><span class="p">(</span><span class="n">spaces</span><span class="o">=</span><span class="n">spaces</span><span class="p">,</span> <span class="n">sloppy</span><span class="o">=</span><span class="n">sloppy</span><span class="p">)</span>
    <span class="n">ds_std_volumes_wf</span> <span class="o">=</span> <span class="n">init_ds_anat_volumes_wf</span><span class="p">(</span>
        <span class="n">bids_root</span><span class="o">=</span><span class="n">bids_root</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">anat_fit_wf</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;t1w&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.t1w&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;t2w&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.t2w&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;roi&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.roi&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;flair&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.flair&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subjects_dir&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subject_id&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">anat_fit_wf</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.template&#39;</span><span class="p">,</span> <span class="s1">&#39;template&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.t1w_preproc&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_preproc&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.t1w_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_mask&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.t1w_dseg&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_dseg&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.t1w_tpms&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_tpms&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.anat2std_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;anat2std_xfm&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.std2anat_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;std2anat_xfm&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.fsnative2t1w_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;fsnative2t1w_xfm&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.sphere_reg&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_reg&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;outputnode.sphere_reg_</span><span class="si">{</span><span class="s1">&#39;msm&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">msm_sulc</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;fsLR&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.anat_ribbon&#39;</span><span class="p">,</span> <span class="s1">&#39;anat_ribbon&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">anat_fit_wf</span><span class="p">,</span> <span class="n">template_iterator_wf</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.template&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.template&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.anat2std_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.anat2std_xfm&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">anat_fit_wf</span><span class="p">,</span> <span class="n">ds_std_volumes_wf</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.t1w_valid_list&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.t1w_preproc&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.anat_preproc&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.t1w_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.anat_mask&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.t1w_dseg&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.anat_dseg&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.t1w_tpms&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.anat_tpms&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">template_iterator_wf</span><span class="p">,</span> <span class="n">ds_std_volumes_wf</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.std_t1w&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.ref_file&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.anat2std_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.anat2std_xfm&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.space&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.space&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.cohort&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.cohort&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.resolution&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.resolution&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="k">if</span> <span class="n">freesurfer</span><span class="p">:</span>
        <span class="n">ds_fs_segs_wf</span> <span class="o">=</span> <span class="n">init_ds_fs_segs_wf</span><span class="p">(</span>
            <span class="n">bids_root</span><span class="o">=</span><span class="n">bids_root</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">surface_derivatives_wf</span> <span class="o">=</span> <span class="n">init_surface_derivatives_wf</span><span class="p">()</span>
        <span class="n">ds_surfaces_wf</span> <span class="o">=</span> <span class="n">init_ds_surfaces_wf</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">surfaces</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;inflated&#39;</span><span class="p">])</span>
        <span class="n">ds_curv_wf</span> <span class="o">=</span> <span class="n">init_ds_surface_metrics_wf</span><span class="p">(</span>
            <span class="n">bids_root</span><span class="o">=</span><span class="n">bids_root</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;curv&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ds_curv_wf&#39;</span>
        <span class="p">)</span>

        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">anat_fit_wf</span><span class="p">,</span> <span class="n">surface_derivatives_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.t1w_preproc&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.reference&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subjects_dir&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subject_id&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.fsnative2t1w_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.fsnative2anat_xfm&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">anat_fit_wf</span><span class="p">,</span> <span class="n">ds_surfaces_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.t1w_valid_list&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">surface_derivatives_wf</span><span class="p">,</span> <span class="n">ds_surfaces_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.inflated&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.inflated&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">anat_fit_wf</span><span class="p">,</span> <span class="n">ds_curv_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.t1w_valid_list&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">surface_derivatives_wf</span><span class="p">,</span> <span class="n">ds_curv_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.curv&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.curv&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">anat_fit_wf</span><span class="p">,</span> <span class="n">ds_fs_segs_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.t1w_valid_list&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">surface_derivatives_wf</span><span class="p">,</span> <span class="n">ds_fs_segs_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.out_aseg&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.anat_fs_aseg&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.out_aparc&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.anat_fs_aparc&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">surface_derivatives_wf</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.out_aseg&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_aseg&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.out_aparc&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_aparc&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>

        <span class="k">if</span> <span class="n">cifti_output</span><span class="p">:</span>
            <span class="n">hcp_morphometrics_wf</span> <span class="o">=</span> <span class="n">init_hcp_morphometrics_wf</span><span class="p">(</span><span class="n">omp_nthreads</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">)</span>
            <span class="n">resample_surfaces_wf</span> <span class="o">=</span> <span class="n">init_resample_surfaces_wf</span><span class="p">(</span>
                <span class="n">surfaces</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;pial&#39;</span><span class="p">,</span> <span class="s1">&#39;midthickness&#39;</span><span class="p">],</span>
                <span class="n">density</span><span class="o">=</span><span class="s1">&#39;32k&#39;</span> <span class="k">if</span> <span class="n">cifti_output</span> <span class="o">==</span> <span class="s1">&#39;91k&#39;</span> <span class="k">else</span> <span class="s1">&#39;59k&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">morph_grayords_wf</span> <span class="o">=</span> <span class="n">init_morph_grayords_wf</span><span class="p">(</span>
                <span class="n">grayord_density</span><span class="o">=</span><span class="n">cifti_output</span><span class="p">,</span> <span class="n">omp_nthreads</span><span class="o">=</span><span class="n">omp_nthreads</span>
            <span class="p">)</span>

            <span class="n">ds_fsLR_surfaces_wf</span> <span class="o">=</span> <span class="n">init_ds_surfaces_wf</span><span class="p">(</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
                <span class="n">surfaces</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;pial&#39;</span><span class="p">,</span> <span class="s1">&#39;midthickness&#39;</span><span class="p">],</span>
                <span class="n">entities</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;space&#39;</span><span class="p">:</span> <span class="s1">&#39;fsLR&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;density&#39;</span><span class="p">:</span> <span class="s1">&#39;32k&#39;</span> <span class="k">if</span> <span class="n">cifti_output</span> <span class="o">==</span> <span class="s1">&#39;91k&#39;</span> <span class="k">else</span> <span class="s1">&#39;59k&#39;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ds_fsLR_surfaces_wf&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ds_grayord_metrics_wf</span> <span class="o">=</span> <span class="n">init_ds_grayord_metrics_wf</span><span class="p">(</span>
                <span class="n">bids_root</span><span class="o">=</span><span class="n">bids_root</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;curv&#39;</span><span class="p">,</span> <span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;sulc&#39;</span><span class="p">],</span>
                <span class="n">cifti_output</span><span class="o">=</span><span class="n">cifti_output</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
                <span class="p">(</span><span class="n">anat_fit_wf</span><span class="p">,</span> <span class="n">hcp_morphometrics_wf</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subject_id&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.sulc&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.sulc&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.thickness&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.midthickness&#39;</span><span class="p">),</span>
                <span class="p">]),</span>
                <span class="p">(</span><span class="n">surface_derivatives_wf</span><span class="p">,</span> <span class="n">hcp_morphometrics_wf</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.curv&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.curv&#39;</span><span class="p">),</span>
                <span class="p">]),</span>
                <span class="p">(</span><span class="n">anat_fit_wf</span><span class="p">,</span> <span class="n">resample_surfaces_wf</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.white&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.white&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.pial&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.pial&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.midthickness&#39;</span><span class="p">),</span>
                    <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;outputnode.sphere_reg_</span><span class="si">{</span><span class="s1">&#39;msm&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">msm_sulc</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;fsLR&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s1">&#39;inputnode.sphere_reg_fsLR&#39;</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">]),</span>
                <span class="p">(</span><span class="n">anat_fit_wf</span><span class="p">,</span> <span class="n">morph_grayords_wf</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.midthickness&#39;</span><span class="p">),</span>
                    <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;outputnode.sphere_reg_</span><span class="si">{</span><span class="s1">&#39;msm&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">msm_sulc</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;fsLR&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s1">&#39;inputnode.sphere_reg_fsLR&#39;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.cortex_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.roi&#39;</span><span class="p">),</span>
                <span class="p">]),</span>
                <span class="p">(</span><span class="n">hcp_morphometrics_wf</span><span class="p">,</span> <span class="n">morph_grayords_wf</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.curv&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.curv&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.sulc&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.sulc&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.thickness&#39;</span><span class="p">),</span>
                <span class="p">]),</span>
                <span class="p">(</span><span class="n">resample_surfaces_wf</span><span class="p">,</span> <span class="n">morph_grayords_wf</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.midthickness_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.midthickness_fsLR&#39;</span><span class="p">),</span>
                <span class="p">]),</span>
                <span class="p">(</span><span class="n">anat_fit_wf</span><span class="p">,</span> <span class="n">ds_fsLR_surfaces_wf</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.t1w_valid_list&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">),</span>
                <span class="p">]),</span>
                <span class="p">(</span><span class="n">anat_fit_wf</span><span class="p">,</span> <span class="n">ds_grayord_metrics_wf</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.t1w_valid_list&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">),</span>
                <span class="p">]),</span>
                <span class="p">(</span><span class="n">resample_surfaces_wf</span><span class="p">,</span> <span class="n">ds_fsLR_surfaces_wf</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.white_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.white&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.pial_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.pial&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.midthickness_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.midthickness&#39;</span><span class="p">),</span>
                <span class="p">]),</span>
                <span class="p">(</span><span class="n">morph_grayords_wf</span><span class="p">,</span> <span class="n">ds_grayord_metrics_wf</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.curv_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.curv&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.curv_metadata&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.curv_metadata&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.thickness_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.thickness&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.thickness_metadata&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.thickness_metadata&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.sulc_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.sulc&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.sulc_metadata&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.sulc_metadata&#39;</span><span class="p">),</span>
                <span class="p">]),</span>
            <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="k">return</span> <span class="n">workflow</span></div>



<div class="viewcode-block" id="init_anat_fit_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.anatomical.html#smriprep.workflows.anatomical.init_anat_fit_wf">[docs]</a>
<span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;anat.fit&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_anat_fit_wf</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">bids_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">freesurfer</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">hires</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">longitudinal</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">msm_sulc</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">t1w</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">t2w</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">skull_strip_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">skull_strip_template</span><span class="p">:</span> <span class="n">Reference</span><span class="p">,</span>
    <span class="n">spaces</span><span class="p">:</span> <span class="n">SpatialReferences</span><span class="p">,</span>
    <span class="n">precomputed</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">omp_nthreads</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">flair</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">(),</span>  <span class="c1"># Remove default after callers start passing it</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">sloppy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_fit_wf&#39;</span><span class="p">,</span>
    <span class="n">skull_strip_fixed_seed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">fs_no_resume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stage the anatomical preprocessing steps of *sMRIPrep*.</span>

<span class="sd">    This includes:</span>

<span class="sd">      - T1w reference: realigning and then averaging T1w images.</span>
<span class="sd">      - Brain extraction and INU (bias field) correction.</span>
<span class="sd">      - Brain tissue segmentation.</span>
<span class="sd">      - Spatial normalization to standard spaces.</span>
<span class="sd">      - Surface reconstruction with FreeSurfer_.</span>

<span class="sd">    .. include:: ../links.rst</span>

<span class="sd">    Workflow Graph</span>
<span class="sd">        .. workflow::</span>
<span class="sd">            :graph2use: orig</span>
<span class="sd">            :simple_form: yes</span>

<span class="sd">            from niworkflows.utils.spaces import SpatialReferences, Reference</span>
<span class="sd">            from smriprep.workflows.anatomical import init_anat_fit_wf</span>
<span class="sd">            wf = init_anat_fit_wf(</span>
<span class="sd">                bids_root=&#39;.&#39;,</span>
<span class="sd">                output_dir=&#39;.&#39;,</span>
<span class="sd">                freesurfer=True,</span>
<span class="sd">                hires=True,</span>
<span class="sd">                longitudinal=False,</span>
<span class="sd">                msm_sulc=True,</span>
<span class="sd">                t1w=[&#39;t1w.nii.gz&#39;],</span>
<span class="sd">                t2w=[&#39;t2w.nii.gz&#39;],</span>
<span class="sd">                flair=[],</span>
<span class="sd">                skull_strip_mode=&#39;force&#39;,</span>
<span class="sd">                skull_strip_template=Reference(&#39;OASIS30ANTs&#39;),</span>
<span class="sd">                spaces=SpatialReferences(spaces=[&#39;MNI152NLin2009cAsym&#39;, &#39;fsaverage5&#39;]),</span>
<span class="sd">                precomputed={},</span>
<span class="sd">                debug=False,</span>
<span class="sd">                sloppy=False,</span>
<span class="sd">                omp_nthreads=1,</span>
<span class="sd">            )</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bids_root : :obj:`str`</span>
<span class="sd">        Path of the input BIDS dataset root</span>
<span class="sd">    output_dir : :obj:`str`</span>
<span class="sd">        Directory in which to save derivatives</span>
<span class="sd">    freesurfer : :obj:`bool`</span>
<span class="sd">        Enable FreeSurfer surface reconstruction (increases runtime by 6h,</span>
<span class="sd">        at the very least)</span>
<span class="sd">    hires : :obj:`bool`</span>
<span class="sd">        Enable sub-millimeter preprocessing in FreeSurfer</span>
<span class="sd">    longitudinal : :obj:`bool`</span>
<span class="sd">        Create unbiased structural template, regardless of number of inputs</span>
<span class="sd">        (may increase runtime)</span>
<span class="sd">    t1w : :obj:`list`</span>
<span class="sd">        List of T1-weighted structural images.</span>
<span class="sd">    skull_strip_mode : :obj:`str`</span>
<span class="sd">        Determiner for T1-weighted skull stripping (`force` ensures skull stripping,</span>
<span class="sd">        `skip` ignores skull stripping, and `auto` automatically ignores skull stripping</span>
<span class="sd">        if pre-stripped brains are detected).</span>
<span class="sd">    skull_strip_template : :py:class:`~niworkflows.utils.spaces.Reference`</span>
<span class="sd">        Spatial reference to use in atlas-based brain extraction.</span>
<span class="sd">    spaces : :py:class:`~niworkflows.utils.spaces.SpatialReferences`</span>
<span class="sd">        Object containing standard and nonstandard space specifications.</span>
<span class="sd">    precomputed : :obj:`dict`</span>
<span class="sd">        Dictionary mapping output specification attribute names and</span>
<span class="sd">        paths to precomputed derivatives.</span>
<span class="sd">    omp_nthreads : :obj:`int`</span>
<span class="sd">        Maximum number of threads an individual process may use</span>
<span class="sd">    debug : :obj:`bool`</span>
<span class="sd">        Enable debugging outputs</span>
<span class="sd">    sloppy: :obj:`bool`</span>
<span class="sd">        Quick, impercise operations. Used to decrease workflow duration.</span>
<span class="sd">    name : :obj:`str`, optional</span>
<span class="sd">        Workflow name (default: anat_fit_wf)</span>
<span class="sd">    skull_strip_fixed_seed : :obj:`bool`</span>
<span class="sd">        Do not use a random seed for skull-stripping - will ensure</span>
<span class="sd">        run-to-run replicability when used with --omp-nthreads 1</span>
<span class="sd">        (default: ``False``).</span>

<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    t1w</span>
<span class="sd">        List of T1-weighted structural images</span>
<span class="sd">    t2w</span>
<span class="sd">        List of T2-weighted structural images</span>
<span class="sd">    roi</span>
<span class="sd">        A mask to exclude regions during standardization</span>
<span class="sd">    flair</span>
<span class="sd">        List of FLAIR images</span>
<span class="sd">    subjects_dir</span>
<span class="sd">        FreeSurfer SUBJECTS_DIR</span>
<span class="sd">    subject_id</span>
<span class="sd">        FreeSurfer subject ID</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    t1w_preproc</span>
<span class="sd">        The T1w reference map, which is calculated as the average of bias-corrected</span>
<span class="sd">        and preprocessed T1w images, defining the anatomical space.</span>
<span class="sd">    t1w_mask</span>
<span class="sd">        Brain (binary) mask estimated by brain extraction.</span>
<span class="sd">    t1w_dseg</span>
<span class="sd">        Brain tissue segmentation of the preprocessed structural image, including</span>
<span class="sd">        gray-matter (GM), white-matter (WM) and cerebrospinal fluid (CSF).</span>
<span class="sd">    t1w_tpms</span>
<span class="sd">        List of tissue probability maps corresponding to ``t1w_dseg``.</span>
<span class="sd">    t1w_valid_list</span>
<span class="sd">        List of input T1w images accepted for preprocessing. If t1w_preproc is</span>
<span class="sd">        precomputed, this is always a list containing that image.</span>
<span class="sd">    template</span>
<span class="sd">        List of template names to which the structural image has been registered</span>
<span class="sd">    anat2std_xfm</span>
<span class="sd">        List of nonlinear spatial transforms to resample data from subject</span>
<span class="sd">        anatomical space into standard template spaces. Collated with template.</span>
<span class="sd">    std2anat_xfm</span>
<span class="sd">        List of nonlinear spatial transforms to resample data from standard</span>
<span class="sd">        template spaces into subject anatomical space. Collated with template.</span>
<span class="sd">    subjects_dir</span>
<span class="sd">        FreeSurfer SUBJECTS_DIR; use as input to a node to ensure that it is run after</span>
<span class="sd">        FreeSurfer reconstruction is completed.</span>
<span class="sd">    subject_id</span>
<span class="sd">        FreeSurfer subject ID; use as input to a node to ensure that it is run after</span>
<span class="sd">        FreeSurfer reconstruction is completed.</span>
<span class="sd">    fsnative2t1w_xfm</span>
<span class="sd">        ITK-style affine matrix translating from FreeSurfer-conformed subject space to T1w</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    * :py:func:`~niworkflows.anat.ants.init_brain_extraction_wf`</span>
<span class="sd">    * :py:func:`~smriprep.workflows.surfaces.init_surface_recon_wf`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="n">num_t1w</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t1w</span><span class="p">)</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Anatomical data preprocessing</span>

<span class="s2">: A total of </span><span class="si">{</span><span class="n">num_t1w</span><span class="si">}</span><span class="s2"> T1-weighted (T1w) images were found within the input</span>
<span class="s2">BIDS dataset.&quot;&quot;&quot;</span>

    <span class="n">have_t1w</span> <span class="o">=</span> <span class="s1">&#39;t1w_preproc&#39;</span> <span class="ow">in</span> <span class="n">precomputed</span>
    <span class="n">have_t2w</span> <span class="o">=</span> <span class="s1">&#39;t2w_preproc&#39;</span> <span class="ow">in</span> <span class="n">precomputed</span>
    <span class="n">have_mask</span> <span class="o">=</span> <span class="s1">&#39;t1w_mask&#39;</span> <span class="ow">in</span> <span class="n">precomputed</span>
    <span class="n">have_dseg</span> <span class="o">=</span> <span class="s1">&#39;t1w_dseg&#39;</span> <span class="ow">in</span> <span class="n">precomputed</span>
    <span class="n">have_tpms</span> <span class="o">=</span> <span class="s1">&#39;t1w_tpms&#39;</span> <span class="ow">in</span> <span class="n">precomputed</span>

    <span class="c1"># Organization</span>
    <span class="c1"># ------------</span>
    <span class="c1"># This workflow takes the usual (inputnode -&gt; graph -&gt; outputnode) format</span>
    <span class="c1"># The graph consists of (input -&gt; compute -&gt; datasink -&gt; buffer) units,</span>
    <span class="c1"># and all inputs to outputnode are buffer.</span>
    <span class="c1"># If precomputed inputs are found, then these units are replaced with (buffer)</span>
    <span class="c1">#     At the time of writing, t1w_mask is an exception, which takes the form</span>
    <span class="c1">#     (t1w_buffer -&gt; refined_buffer -&gt; datasink -&gt; outputnode)</span>
    <span class="c1"># All outputnode components should therefore point to files in the input or</span>
    <span class="c1"># output directories.</span>
    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;t1w&#39;</span><span class="p">,</span> <span class="s1">&#39;t2w&#39;</span><span class="p">,</span> <span class="s1">&#39;roi&#39;</span><span class="p">,</span> <span class="s1">&#39;flair&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="c1"># Primary derivatives</span>
                <span class="s1">&#39;t1w_preproc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;t2w_preproc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;t1w_mask&#39;</span><span class="p">,</span>
                <span class="s1">&#39;t1w_dseg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;t1w_tpms&#39;</span><span class="p">,</span>
                <span class="s1">&#39;anat2std_xfm&#39;</span><span class="p">,</span>
                <span class="s1">&#39;fsnative2t1w_xfm&#39;</span><span class="p">,</span>
                <span class="c1"># Surface and metric derivatives for fsLR resampling</span>
                <span class="s1">&#39;white&#39;</span><span class="p">,</span>
                <span class="s1">&#39;pial&#39;</span><span class="p">,</span>
                <span class="s1">&#39;midthickness&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sphere&#39;</span><span class="p">,</span>
                <span class="s1">&#39;thickness&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sulc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sphere_reg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sphere_reg_msm&#39;</span><span class="p">,</span>
                <span class="s1">&#39;cortex_mask&#39;</span><span class="p">,</span>
                <span class="s1">&#39;anat_ribbon&#39;</span><span class="p">,</span>
                <span class="c1"># Reverse transform; not computable from forward transform</span>
                <span class="s1">&#39;std2anat_xfm&#39;</span><span class="p">,</span>
                <span class="c1"># Metadata</span>
                <span class="s1">&#39;template&#39;</span><span class="p">,</span>
                <span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span>
                <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span>
                <span class="s1">&#39;t1w_valid_list&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># If all derivatives exist, inputnode could go unconnected, so add explicitly</span>
    <span class="n">workflow</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">([</span><span class="n">inputnode</span><span class="p">])</span>

    <span class="c1"># Stage 1 inputs (filtered)</span>
    <span class="n">sourcefile_buffer</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;source_files&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sourcefile_buffer&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stage 2 results</span>
    <span class="n">t1w_buffer</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;t1w_preproc&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_brain&#39;</span><span class="p">,</span> <span class="s1">&#39;ants_seg&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;t1w_buffer&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Stage 3 results</span>
    <span class="n">seg_buffer</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;t1w_dseg&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_tpms&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;seg_buffer&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Stage 4 results: collated template names, forward and reverse transforms</span>
    <span class="n">template_buffer</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;template_buffer&#39;</span><span class="p">)</span>
    <span class="n">anat2std_buffer</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat2std_buffer&#39;</span><span class="p">)</span>
    <span class="n">std2anat_buffer</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;std2anat_buffer&#39;</span><span class="p">)</span>

    <span class="c1"># Stage 6 results: Refined stage 2 results; may be direct copy if no refinement</span>
    <span class="n">refined_buffer</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;t1w_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_brain&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;refined_buffer&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stage 8 results: GIFTI surfaces</span>
    <span class="n">surfaces_buffer</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;pial&#39;</span><span class="p">,</span> <span class="s1">&#39;midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_reg&#39;</span><span class="p">,</span> <span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;sulc&#39;</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;surfaces_buffer&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stage 9 and 10 results: fsLR sphere registration</span>
    <span class="n">fsLR_buffer</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fsLR_buffer&#39;</span><span class="p">)</span>
    <span class="n">msm_buffer</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sphere_reg_msm&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;msm_buffer&#39;</span><span class="p">)</span>

    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">seg_buffer</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;t1w_dseg&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_dseg&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;t1w_tpms&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_tpms&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">anat2std_buffer</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;anat2std_xfm&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">std2anat_buffer</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;std2anat_xfm&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">template_buffer</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;template&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">sourcefile_buffer</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;source_files&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_valid_list&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">surfaces_buffer</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;pial&#39;</span><span class="p">,</span> <span class="s1">&#39;pial&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;midthickness&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;sphere&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;sphere_reg&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_reg&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;thickness&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;sulc&#39;</span><span class="p">,</span> <span class="s1">&#39;sulc&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">fsLR_buffer</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">msm_buffer</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;sphere_reg_msm&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_reg_msm&#39;</span><span class="p">)]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="c1"># Reporting</span>
    <span class="n">anat_reports_wf</span> <span class="o">=</span> <span class="n">init_anat_reports_wf</span><span class="p">(</span>
        <span class="n">spaces</span><span class="o">=</span><span class="n">spaces</span><span class="p">,</span>
        <span class="n">freesurfer</span><span class="o">=</span><span class="n">freesurfer</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
        <span class="n">sloppy</span><span class="o">=</span><span class="n">sloppy</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">outputnode</span><span class="p">,</span> <span class="n">anat_reports_wf</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;t1w_valid_list&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_file&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;t1w_preproc&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.t1w_preproc&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;t1w_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.t1w_mask&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;t1w_dseg&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.t1w_dseg&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.template&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;anat2std_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.anat2std_xfm&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subjects_dir&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subject_id&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="c1"># Stage 1: Conform images and validate</span>
    <span class="c1"># If desc-preproc_T1w.nii.gz is provided, just validate it</span>
    <span class="n">anat_validate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">ValidateImage</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_validate&#39;</span><span class="p">,</span> <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">have_t1w</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 1: Adding template workflow&#39;</span><span class="p">)</span>
        <span class="n">ants_ver</span> <span class="o">=</span> <span class="n">ANTsInfo</span><span class="o">.</span><span class="n">version</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;(version unknown)&#39;</span>
        <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Each&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">num_t1w</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;The&#39;</span><span class="si">}</span><span class="s2"> T1w image was corrected for intensity</span>
<span class="s2">non-uniformity (INU) with `N4BiasFieldCorrection` [@n4], distributed with ANTs </span><span class="si">{</span><span class="n">ants_ver</span><span class="si">}</span>
<span class="s2">[@ants, RRID:SCR_004757]&quot;&quot;&quot;</span>
        <span class="n">desc</span> <span class="o">+=</span> <span class="s1">&#39;.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">num_t1w</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;, and used as T1w-reference throughout the workflow.</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">anat_template_wf</span> <span class="o">=</span> <span class="n">init_anat_template_wf</span><span class="p">(</span>
            <span class="n">longitudinal</span><span class="o">=</span><span class="n">longitudinal</span><span class="p">,</span>
            <span class="n">omp_nthreads</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
            <span class="n">num_files</span><span class="o">=</span><span class="n">num_t1w</span><span class="p">,</span>
            <span class="n">image_type</span><span class="o">=</span><span class="s1">&#39;T1w&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_template_wf&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ds_template_wf</span> <span class="o">=</span> <span class="n">init_ds_template_wf</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">num_anat</span><span class="o">=</span><span class="n">num_t1w</span><span class="p">,</span> <span class="n">image_type</span><span class="o">=</span><span class="s1">&#39;T1w&#39;</span>
        <span class="p">)</span>

        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">anat_template_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t1w&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.anat_files&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">anat_template_wf</span><span class="p">,</span> <span class="n">anat_validate</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.anat_ref&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">anat_template_wf</span><span class="p">,</span> <span class="n">sourcefile_buffer</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.anat_valid_list&#39;</span><span class="p">,</span> <span class="s1">&#39;source_files&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">anat_template_wf</span><span class="p">,</span> <span class="n">anat_reports_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.out_report&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.t1w_conform_report&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">anat_template_wf</span><span class="p">,</span> <span class="n">ds_template_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.anat_realign_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.anat_ref_xfms&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">sourcefile_buffer</span><span class="p">,</span> <span class="n">ds_template_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;source_files&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">t1w_buffer</span><span class="p">,</span> <span class="n">ds_template_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t1w_preproc&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.anat_preproc&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">ds_template_wf</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.anat_preproc&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_preproc&#39;</span><span class="p">)]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Found preprocessed T1w - skipping Stage 1&#39;</span><span class="p">)</span>
        <span class="n">desc</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot; A preprocessed T1w image was provided as a precomputed input</span>
<span class="s2">and used as T1w-reference throughout the workflow.</span>
<span class="s2">&quot;&quot;&quot;</span>

        <span class="n">anat_validate</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="n">precomputed</span><span class="p">[</span><span class="s1">&#39;t1w_preproc&#39;</span><span class="p">]</span>
        <span class="n">sourcefile_buffer</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">source_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">precomputed</span><span class="p">[</span><span class="s1">&#39;t1w_preproc&#39;</span><span class="p">]]</span>

        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">anat_validate</span><span class="p">,</span> <span class="n">t1w_buffer</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_preproc&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">t1w_buffer</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t1w_preproc&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_preproc&#39;</span><span class="p">)]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="c1"># Stage 2: INU correction and masking</span>
    <span class="c1"># We always need to generate t1w_brain; how to do that depends on whether we have</span>
    <span class="c1"># a pre-corrected T1w or precomputed mask, or are given an already masked image</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">have_mask</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 2: Preparing brain extraction workflow&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">skull_strip_mode</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">run_skull_strip</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">_is_skull_stripped</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">t1w</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run_skull_strip</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;force&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;skip&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}[</span><span class="n">skull_strip_mode</span><span class="p">]</span>

        <span class="c1"># Brain extraction</span>
        <span class="k">if</span> <span class="n">run_skull_strip</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">The T1w-reference was then skull-stripped with a *Nipype* implementation of</span>
<span class="s2">the `antsBrainExtraction.sh` workflow (from ANTs), using </span><span class="si">{</span><span class="n">skull_strip_template</span><span class="o">.</span><span class="n">fullname</span><span class="si">}</span>
<span class="s2">as target template.</span>
<span class="s2">&quot;&quot;&quot;</span>
            <span class="n">brain_extraction_wf</span> <span class="o">=</span> <span class="n">init_brain_extraction_wf</span><span class="p">(</span>
                <span class="n">in_template</span><span class="o">=</span><span class="n">skull_strip_template</span><span class="o">.</span><span class="n">space</span><span class="p">,</span>
                <span class="n">template_spec</span><span class="o">=</span><span class="n">skull_strip_template</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
                <span class="n">atropos_use_random_seed</span><span class="o">=</span><span class="ow">not</span> <span class="n">skull_strip_fixed_seed</span><span class="p">,</span>
                <span class="n">omp_nthreads</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
                <span class="n">normalization_quality</span><span class="o">=</span><span class="s1">&#39;precise&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">sloppy</span> <span class="k">else</span> <span class="s1">&#39;testing&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
                <span class="p">(</span><span class="n">anat_validate</span><span class="p">,</span> <span class="n">brain_extraction_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.in_files&#39;</span><span class="p">)]),</span>
                <span class="p">(</span><span class="n">brain_extraction_wf</span><span class="p">,</span> <span class="n">t1w_buffer</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.out_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_mask&#39;</span><span class="p">),</span>
                    <span class="p">((</span><span class="s1">&#39;outputnode.out_file&#39;</span><span class="p">,</span> <span class="n">_pop</span><span class="p">),</span> <span class="s1">&#39;t1w_brain&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.out_segm&#39;</span><span class="p">,</span> <span class="s1">&#39;ants_seg&#39;</span><span class="p">),</span>
                <span class="p">]),</span>
            <span class="p">])</span>  <span class="c1"># fmt:skip</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">have_t1w</span><span class="p">:</span>
                <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
                    <span class="p">(</span><span class="n">brain_extraction_wf</span><span class="p">,</span> <span class="n">t1w_buffer</span><span class="p">,</span> <span class="p">[</span>
                        <span class="p">((</span><span class="s1">&#39;outputnode.bias_corrected&#39;</span><span class="p">,</span> <span class="n">_pop</span><span class="p">),</span> <span class="s1">&#39;t1w_preproc&#39;</span><span class="p">),</span>
                    <span class="p">]),</span>
                <span class="p">])</span>  <span class="c1"># fmt:skip</span>
        <span class="c1"># Determine mask from T1w and uniformize</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">have_t1w</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 2: Skipping skull-strip, INU-correction only&#39;</span><span class="p">)</span>
            <span class="n">desc</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">The provided T1w image was previously skull-stripped; a brain mask was</span>
<span class="s2">derived from the input image.</span>
<span class="s2">&quot;&quot;&quot;</span>
            <span class="n">n4_only_wf</span> <span class="o">=</span> <span class="n">init_n4_only_wf</span><span class="p">(</span>
                <span class="n">omp_nthreads</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
                <span class="n">atropos_use_random_seed</span><span class="o">=</span><span class="ow">not</span> <span class="n">skull_strip_fixed_seed</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
                <span class="p">(</span><span class="n">anat_validate</span><span class="p">,</span> <span class="n">n4_only_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.in_files&#39;</span><span class="p">)]),</span>
                <span class="p">(</span><span class="n">n4_only_wf</span><span class="p">,</span> <span class="n">t1w_buffer</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">((</span><span class="s1">&#39;outputnode.bias_corrected&#39;</span><span class="p">,</span> <span class="n">_pop</span><span class="p">),</span> <span class="s1">&#39;t1w_preproc&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.out_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_mask&#39;</span><span class="p">),</span>
                    <span class="p">((</span><span class="s1">&#39;outputnode.out_file&#39;</span><span class="p">,</span> <span class="n">_pop</span><span class="p">),</span> <span class="s1">&#39;t1w_brain&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outputnode.out_segm&#39;</span><span class="p">,</span> <span class="s1">&#39;ants_seg&#39;</span><span class="p">),</span>
                <span class="p">]),</span>
            <span class="p">])</span>  <span class="c1"># fmt:skip</span>
        <span class="c1"># Binarize the already uniformized image</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 2: Skipping skull-strip, generating mask from input&#39;</span><span class="p">)</span>
            <span class="n">desc</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">The provided T1w image was previously skull-stripped; a brain mask was</span>
<span class="s2">derived from the input image.</span>
<span class="s2">&quot;&quot;&quot;</span>
            <span class="n">binarize</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">Binarize</span><span class="p">(</span><span class="n">thresh_low</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;binarize&#39;</span><span class="p">)</span>
            <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
                <span class="p">(</span><span class="n">anat_validate</span><span class="p">,</span> <span class="n">binarize</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
                <span class="p">(</span><span class="n">anat_validate</span><span class="p">,</span> <span class="n">t1w_buffer</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_brain&#39;</span><span class="p">)]),</span>
                <span class="p">(</span><span class="n">binarize</span><span class="p">,</span> <span class="n">t1w_buffer</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_mask&#39;</span><span class="p">)]),</span>
            <span class="p">])</span>  <span class="c1"># fmt:skip</span>

        <span class="n">ds_t1w_mask_wf</span> <span class="o">=</span> <span class="n">init_ds_mask_wf</span><span class="p">(</span>
            <span class="n">bids_root</span><span class="o">=</span><span class="n">bids_root</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="n">mask_type</span><span class="o">=</span><span class="s1">&#39;brain&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ds_t1w_mask_wf&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">sourcefile_buffer</span><span class="p">,</span> <span class="n">ds_t1w_mask_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;source_files&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">refined_buffer</span><span class="p">,</span> <span class="n">ds_t1w_mask_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t1w_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.mask_file&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">ds_t1w_mask_wf</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.mask_file&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_mask&#39;</span><span class="p">)]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Found brain mask&#39;</span><span class="p">)</span>
        <span class="n">desc</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">A pre-computed brain mask was provided as input and used throughout the workflow.</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="n">t1w_buffer</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">t1w_mask</span> <span class="o">=</span> <span class="n">precomputed</span><span class="p">[</span><span class="s1">&#39;t1w_mask&#39;</span><span class="p">]</span>
        <span class="c1"># If we have a mask, always apply it</span>
        <span class="n">apply_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">ApplyMask</span><span class="p">(</span><span class="n">in_mask</span><span class="o">=</span><span class="n">precomputed</span><span class="p">[</span><span class="s1">&#39;t1w_mask&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;apply_mask&#39;</span><span class="p">)</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">anat_validate</span><span class="p">,</span> <span class="n">apply_mask</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)])])</span>
        <span class="c1"># Run N4 if it hasn&#39;t been pre-run</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">have_t1w</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Skipping skull-strip, INU-correction only&#39;</span><span class="p">)</span>
            <span class="n">n4_only_wf</span> <span class="o">=</span> <span class="n">init_n4_only_wf</span><span class="p">(</span>
                <span class="n">omp_nthreads</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
                <span class="n">atropos_use_random_seed</span><span class="o">=</span><span class="ow">not</span> <span class="n">skull_strip_fixed_seed</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
                <span class="p">(</span><span class="n">apply_mask</span><span class="p">,</span> <span class="n">n4_only_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.in_files&#39;</span><span class="p">)]),</span>
                <span class="p">(</span><span class="n">n4_only_wf</span><span class="p">,</span> <span class="n">t1w_buffer</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">((</span><span class="s1">&#39;outputnode.bias_corrected&#39;</span><span class="p">,</span> <span class="n">_pop</span><span class="p">),</span> <span class="s1">&#39;t1w_preproc&#39;</span><span class="p">),</span>
                    <span class="p">((</span><span class="s1">&#39;outputnode.out_file&#39;</span><span class="p">,</span> <span class="n">_pop</span><span class="p">),</span> <span class="s1">&#39;t1w_brain&#39;</span><span class="p">),</span>
                <span class="p">]),</span>
            <span class="p">])</span>  <span class="c1"># fmt:skip</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Skipping Stage 2&#39;</span><span class="p">)</span>
            <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">apply_mask</span><span class="p">,</span> <span class="n">t1w_buffer</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_brain&#39;</span><span class="p">)])])</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">refined_buffer</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t1w_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_mask&#39;</span><span class="p">)])])</span>

    <span class="c1"># Stage 3: Segmentation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">have_dseg</span> <span class="ow">and</span> <span class="n">have_tpms</span><span class="p">):</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 3: Preparing segmentation workflow&#39;</span><span class="p">)</span>
        <span class="n">fsl_ver</span> <span class="o">=</span> <span class="n">FAST</span><span class="p">()</span><span class="o">.</span><span class="n">version</span> <span class="ow">or</span> <span class="s1">&#39;(version unknown)&#39;</span>
        <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Brain tissue segmentation of cerebrospinal fluid (CSF),</span>
<span class="s2">white-matter (WM) and gray-matter (GM) was performed on</span>
<span class="s2">the brain-extracted T1w using `fast` [FSL </span><span class="si">{</span><span class="n">fsl_ver</span><span class="si">}</span><span class="s2">, RRID:SCR_002823, @fsl_fast].</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="n">fast</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
            <span class="n">FAST</span><span class="p">(</span><span class="n">segments</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">no_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">probability_maps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bias_iters</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fast&#39;</span><span class="p">,</span>
            <span class="n">mem_gb</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">lut_t1w_dseg</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">_apply_bids_lut</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lut_t1w_dseg&#39;</span><span class="p">)</span>
        <span class="n">lut_t1w_dseg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">lut</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Maps: 0 -&gt; 0, 3 -&gt; 1, 1 -&gt; 2, 2 -&gt; 3.</span>
        <span class="n">fast2bids</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
            <span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">_probseg_fast2bids</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fast2bids&#39;</span><span class="p">,</span>
            <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">refined_buffer</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t1w_brain&#39;</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span><span class="p">)])])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">have_dseg</span><span class="p">:</span>
            <span class="n">ds_dseg_wf</span> <span class="o">=</span> <span class="n">init_ds_dseg_wf</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>
            <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
                <span class="p">(</span><span class="n">fast</span><span class="p">,</span> <span class="n">lut_t1w_dseg</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;partial_volume_map&#39;</span><span class="p">,</span> <span class="s1">&#39;in_dseg&#39;</span><span class="p">)]),</span>
                <span class="p">(</span><span class="n">sourcefile_buffer</span><span class="p">,</span> <span class="n">ds_dseg_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;source_files&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">)]),</span>
                <span class="p">(</span><span class="n">lut_t1w_dseg</span><span class="p">,</span> <span class="n">ds_dseg_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.anat_dseg&#39;</span><span class="p">)]),</span>
                <span class="p">(</span><span class="n">ds_dseg_wf</span><span class="p">,</span> <span class="n">seg_buffer</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.anat_dseg&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_dseg&#39;</span><span class="p">)]),</span>
            <span class="p">])</span>  <span class="c1"># fmt:skip</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">have_tpms</span><span class="p">:</span>
            <span class="n">ds_tpms_wf</span> <span class="o">=</span> <span class="n">init_ds_tpms_wf</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>
            <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
                <span class="p">(</span><span class="n">fast</span><span class="p">,</span> <span class="n">fast2bids</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;partial_volume_files&#39;</span><span class="p">,</span> <span class="s1">&#39;inlist&#39;</span><span class="p">)]),</span>
                <span class="p">(</span><span class="n">sourcefile_buffer</span><span class="p">,</span> <span class="n">ds_tpms_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;source_files&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">)]),</span>
                <span class="p">(</span><span class="n">fast2bids</span><span class="p">,</span> <span class="n">ds_tpms_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.anat_tpms&#39;</span><span class="p">)]),</span>
                <span class="p">(</span><span class="n">ds_tpms_wf</span><span class="p">,</span> <span class="n">seg_buffer</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.anat_tpms&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_tpms&#39;</span><span class="p">)]),</span>
            <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Skipping Stage 3&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">have_dseg</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Found discrete segmentation&#39;</span><span class="p">)</span>
        <span class="n">desc</span> <span class="o">+=</span> <span class="s1">&#39;Precomputed discrete tissue segmentations were provided as inputs.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">seg_buffer</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">t1w_dseg</span> <span class="o">=</span> <span class="n">precomputed</span><span class="p">[</span><span class="s1">&#39;t1w_dseg&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">have_tpms</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Found tissue probability maps&#39;</span><span class="p">)</span>
        <span class="n">desc</span> <span class="o">+=</span> <span class="s1">&#39;Precomputed tissue probabiilty maps were provided as inputs.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">seg_buffer</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">t1w_tpms</span> <span class="o">=</span> <span class="n">precomputed</span><span class="p">[</span><span class="s1">&#39;t1w_tpms&#39;</span><span class="p">]</span>

    <span class="c1"># Stage 4: Normalization</span>
    <span class="n">templates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">found_xfms</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">spaces</span><span class="o">.</span><span class="n">get_spaces</span><span class="p">(</span><span class="n">nonstandard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,)):</span>
        <span class="n">xfms</span> <span class="o">=</span> <span class="n">precomputed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transforms&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">xfms</span><span class="p">)</span> <span class="o">!=</span> <span class="p">{</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="s1">&#39;reverse&#39;</span><span class="p">}:</span>
            <span class="n">templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">found_xfms</span><span class="p">[</span><span class="n">template</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfms</span>

    <span class="n">template_buffer</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">in1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">found_xfms</span><span class="p">)</span>
    <span class="n">anat2std_buffer</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">in1</span> <span class="o">=</span> <span class="p">[</span><span class="n">xfm</span><span class="p">[</span><span class="s1">&#39;forward&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">xfm</span> <span class="ow">in</span> <span class="n">found_xfms</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="n">std2anat_buffer</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">in1</span> <span class="o">=</span> <span class="p">[</span><span class="n">xfm</span><span class="p">[</span><span class="s1">&#39;reverse&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">xfm</span> <span class="ow">in</span> <span class="n">found_xfms</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

    <span class="k">if</span> <span class="n">templates</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ANAT Stage 4: Preparing normalization workflow for </span><span class="si">{</span><span class="n">templates</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">register_template_wf</span> <span class="o">=</span> <span class="n">init_register_template_wf</span><span class="p">(</span>
            <span class="n">sloppy</span><span class="o">=</span><span class="n">sloppy</span><span class="p">,</span>
            <span class="n">omp_nthreads</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
            <span class="n">templates</span><span class="o">=</span><span class="n">templates</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ds_template_registration_wf</span> <span class="o">=</span> <span class="n">init_ds_template_registration_wf</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">image_type</span><span class="o">=</span><span class="s1">&#39;T1w&#39;</span>
        <span class="p">)</span>

        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">register_template_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;roi&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.lesion_mask&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">t1w_buffer</span><span class="p">,</span> <span class="n">register_template_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t1w_preproc&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.moving_image&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">refined_buffer</span><span class="p">,</span> <span class="n">register_template_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t1w_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.moving_mask&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">sourcefile_buffer</span><span class="p">,</span> <span class="n">ds_template_registration_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;source_files&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">)</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">register_template_wf</span><span class="p">,</span> <span class="n">ds_template_registration_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.template&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.template&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.anat2std_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.anat2std_xfm&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.std2anat_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.std2anat_xfm&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">register_template_wf</span><span class="p">,</span> <span class="n">template_buffer</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.template&#39;</span><span class="p">,</span> <span class="s1">&#39;in2&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">ds_template_registration_wf</span><span class="p">,</span> <span class="n">std2anat_buffer</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.std2anat_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;in2&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">ds_template_registration_wf</span><span class="p">,</span> <span class="n">anat2std_buffer</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.anat2std_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;in2&#39;</span><span class="p">)]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">if</span> <span class="n">found_xfms</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ANAT Stage 4: Found pre-computed registrations for </span><span class="si">{</span><span class="n">found_xfms</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Do not attempt refinement (Stage 6, below)</span>
    <span class="k">if</span> <span class="n">have_mask</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">freesurfer</span><span class="p">:</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">t1w_buffer</span><span class="p">,</span> <span class="n">refined_buffer</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;t1w_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_mask&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;t1w_brain&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_brain&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="n">workflow</span><span class="o">.</span><span class="n">__desc__</span> <span class="o">=</span> <span class="n">desc</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">freesurfer</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Skipping Stages 5+&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">workflow</span>

    <span class="n">fs_isrunning</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">_fs_isRunning</span><span class="p">),</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fs_isrunning&#39;</span>
    <span class="p">)</span>
    <span class="n">fs_isrunning</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">LOGGER</span>

    <span class="c1"># Stage 5: Surface reconstruction (--fs-no-reconall not set)</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 5: Preparing surface reconstruction workflow&#39;</span><span class="p">)</span>
    <span class="n">surface_recon_wf</span> <span class="o">=</span> <span class="n">init_surface_recon_wf</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;surface_recon_wf&#39;</span><span class="p">,</span>
        <span class="n">omp_nthreads</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
        <span class="n">hires</span><span class="o">=</span><span class="n">hires</span><span class="p">,</span>
        <span class="n">fs_no_resume</span><span class="o">=</span><span class="n">fs_no_resume</span><span class="p">,</span>
        <span class="n">precomputed</span><span class="o">=</span><span class="n">precomputed</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">t2w</span> <span class="ow">or</span> <span class="n">flair</span><span class="p">:</span>
        <span class="n">t2w_or_flair</span> <span class="o">=</span> <span class="s1">&#39;T2-weighted&#39;</span> <span class="k">if</span> <span class="n">t2w</span> <span class="k">else</span> <span class="s1">&#39;FLAIR&#39;</span>
        <span class="n">surface_recon_wf</span><span class="o">.</span><span class="n">__desc__</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">A </span><span class="si">{</span><span class="n">t2w_or_flair</span><span class="si">}</span><span class="s2"> image was used to improve pial surface refinement.</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">fs_isrunning</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">surface_recon_wf</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;t2w&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.t2w&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;flair&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.flair&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subject_id&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">fs_isrunning</span><span class="p">,</span> <span class="n">surface_recon_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subjects_dir&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">anat_validate</span><span class="p">,</span> <span class="n">surface_recon_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.t1w&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">t1w_buffer</span><span class="p">,</span> <span class="n">surface_recon_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t1w_brain&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.skullstripped_t1&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">surface_recon_wf</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outputnode.subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="n">fsnative_xfms</span> <span class="o">=</span> <span class="n">precomputed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transforms&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fsnative&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fsnative_xfms</span><span class="p">:</span>
        <span class="n">ds_fs_registration_wf</span> <span class="o">=</span> <span class="n">init_ds_fs_registration_wf</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">image_type</span><span class="o">=</span><span class="s1">&#39;T1w&#39;</span><span class="p">)</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">sourcefile_buffer</span><span class="p">,</span> <span class="n">ds_fs_registration_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;source_files&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">surface_recon_wf</span><span class="p">,</span> <span class="n">ds_fs_registration_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.fsnative2t1w_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.fsnative2anat_xfm&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">ds_fs_registration_wf</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.fsnative2anat_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;fsnative2t1w_xfm&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">elif</span> <span class="s1">&#39;reverse&#39;</span> <span class="ow">in</span> <span class="n">fsnative_xfms</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Found fsnative-T1w transform - skipping registration&#39;</span><span class="p">)</span>
        <span class="n">outputnode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fsnative2t1w_xfm</span> <span class="o">=</span> <span class="n">fsnative_xfms</span><span class="p">[</span><span class="s1">&#39;reverse&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s1">&#39;Found a T1w-to-fsnative transform without the reverse. Time to handle this.&#39;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">have_mask</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 6: Preparing mask refinement workflow&#39;</span><span class="p">)</span>
        <span class="c1"># Stage 6: Refine ANTs mask with FreeSurfer segmentation</span>
        <span class="n">refinement_wf</span> <span class="o">=</span> <span class="n">init_refinement_wf</span><span class="p">()</span>
        <span class="n">applyrefined</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyMask</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;applyrefined&#39;</span><span class="p">)</span>

        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">surface_recon_wf</span><span class="p">,</span> <span class="n">refinement_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subjects_dir&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subject_id&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.fsnative2t1w_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.fsnative2anat_xfm&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">t1w_buffer</span><span class="p">,</span> <span class="n">refinement_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;t1w_preproc&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.reference_image&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;ants_seg&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.ants_segs&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">t1w_buffer</span><span class="p">,</span> <span class="n">applyrefined</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t1w_preproc&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">refinement_wf</span><span class="p">,</span> <span class="n">applyrefined</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.out_brainmask&#39;</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">refinement_wf</span><span class="p">,</span> <span class="n">refined_buffer</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.out_brainmask&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_mask&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">applyrefined</span><span class="p">,</span> <span class="n">refined_buffer</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;t1w_brain&#39;</span><span class="p">)]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Found brain mask - skipping Stage 6&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">t2w</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">have_t2w</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 7: Creating T2w template&#39;</span><span class="p">)</span>
        <span class="n">t2w_template_wf</span> <span class="o">=</span> <span class="n">init_anat_template_wf</span><span class="p">(</span>
            <span class="n">longitudinal</span><span class="o">=</span><span class="n">longitudinal</span><span class="p">,</span>
            <span class="n">omp_nthreads</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">,</span>
            <span class="n">num_files</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">t2w</span><span class="p">),</span>
            <span class="n">image_type</span><span class="o">=</span><span class="s1">&#39;T2w&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;t2w_template_wf&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">bbreg</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">BBRegister</span><span class="p">(</span>
                <span class="n">contrast_type</span><span class="o">=</span><span class="s1">&#39;t2&#39;</span><span class="p">,</span>
                <span class="n">init</span><span class="o">=</span><span class="s1">&#39;coreg&#39;</span><span class="p">,</span>
                <span class="n">dof</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                <span class="n">out_lta_file</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="s1">&#39;--gm-proj-abs 2 --wm-proj-abs 1&#39;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bbreg&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">coreg_xfms</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;merge_xfms&#39;</span><span class="p">,</span> <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t2wtot1w_xfm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">ConcatenateXFMs</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;t2wtot1w_xfm&#39;</span><span class="p">,</span> <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t2w_resample</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
            <span class="n">ApplyTransforms</span><span class="p">(</span>
                <span class="n">dimension</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">default_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="nb">float</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;LanczosWindowedSinc&#39;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;t2w_resample&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ds_t2w_preproc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
            <span class="n">DerivativesDataSink</span><span class="p">(</span><span class="n">base_directory</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;preproc&#39;</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ds_t2w_preproc&#39;</span><span class="p">,</span>
            <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ds_t2w_preproc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">SkullStripped</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">t2w_template_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t2w&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.anat_files&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">t2w_template_wf</span><span class="p">,</span> <span class="n">bbreg</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.anat_ref&#39;</span><span class="p">,</span> <span class="s1">&#39;source_file&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">surface_recon_wf</span><span class="p">,</span> <span class="n">bbreg</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">bbreg</span><span class="p">,</span> <span class="n">coreg_xfms</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_lta_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in1&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">surface_recon_wf</span><span class="p">,</span> <span class="n">coreg_xfms</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.fsnative2t1w_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;in2&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">coreg_xfms</span><span class="p">,</span> <span class="n">t2wtot1w_xfm</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;in_xfms&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">t2w_template_wf</span><span class="p">,</span> <span class="n">t2w_resample</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.anat_ref&#39;</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">t1w_buffer</span><span class="p">,</span> <span class="n">t2w_resample</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t1w_preproc&#39;</span><span class="p">,</span> <span class="s1">&#39;reference_image&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">t2wtot1w_xfm</span><span class="p">,</span> <span class="n">t2w_resample</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;transforms&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">ds_t2w_preproc</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;t2w&#39;</span><span class="p">,</span> <span class="s1">&#39;source_file&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">t2w_resample</span><span class="p">,</span> <span class="n">ds_t2w_preproc</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;output_image&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">ds_t2w_preproc</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;t2w_preproc&#39;</span><span class="p">)]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">t2w</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT No T2w images provided - skipping Stage 7&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Found preprocessed T2w - skipping Stage 7&#39;</span><span class="p">)</span>

    <span class="c1"># Stages 8-10: Surface conversion and registration</span>
    <span class="c1"># sphere_reg is needed to generate sphere_reg_fsLR</span>
    <span class="c1"># sphere and sulc are needed to generate sphere_reg_msm</span>
    <span class="c1"># white, pial, midthickness and thickness are needed to resample in the cortical ribbon</span>
    <span class="c1"># TODO: Consider paring down or splitting into a subworkflow that can be called on-demand</span>
    <span class="c1"># A subworkflow would still need to check for precomputed outputs</span>
    <span class="n">needed_anat_surfs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;pial&#39;</span><span class="p">,</span> <span class="s1">&#39;midthickness&#39;</span><span class="p">]</span>
    <span class="n">needed_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;sulc&#39;</span><span class="p">]</span>
    <span class="n">needed_spheres</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sphere_reg&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere&#39;</span><span class="p">]</span>

    <span class="c1"># Detect pre-computed surfaces</span>
    <span class="n">found_surfs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">surf</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">precomputed</span><span class="p">[</span><span class="n">surf</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">surf</span> <span class="ow">in</span> <span class="n">needed_anat_surfs</span> <span class="o">+</span> <span class="n">needed_metrics</span> <span class="o">+</span> <span class="n">needed_spheres</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">precomputed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">surf</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">found_surfs</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ANAT Stage 8: Found pre-converted surfaces for </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">found_surfs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">surfaces_buffer</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">trait_set</span><span class="p">(</span><span class="o">**</span><span class="n">found_surfs</span><span class="p">)</span>

    <span class="c1"># Stage 8: Surface conversion</span>
    <span class="n">surfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">surf</span> <span class="k">for</span> <span class="n">surf</span> <span class="ow">in</span> <span class="n">needed_anat_surfs</span> <span class="k">if</span> <span class="n">surf</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">found_surfs</span><span class="p">]</span>
    <span class="n">spheres</span> <span class="o">=</span> <span class="p">[</span><span class="n">sphere</span> <span class="k">for</span> <span class="n">sphere</span> <span class="ow">in</span> <span class="n">needed_spheres</span> <span class="k">if</span> <span class="n">sphere</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">found_surfs</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">surfs</span> <span class="ow">or</span> <span class="n">spheres</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ANAT Stage 8: Creating GIFTI surfaces for </span><span class="si">{</span><span class="n">surfs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">spheres</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">surfs</span><span class="p">:</span>
        <span class="n">gifti_surfaces_wf</span> <span class="o">=</span> <span class="n">init_gifti_surfaces_wf</span><span class="p">(</span><span class="n">surfaces</span><span class="o">=</span><span class="n">surfs</span><span class="p">)</span>
        <span class="n">ds_surfaces_wf</span> <span class="o">=</span> <span class="n">init_ds_surfaces_wf</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">surfaces</span><span class="o">=</span><span class="n">surfs</span><span class="p">)</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">surface_recon_wf</span><span class="p">,</span> <span class="n">gifti_surfaces_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subject_id&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subjects_dir&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.fsnative2t1w_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.fsnative2anat_xfm&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">sourcefile_buffer</span><span class="p">,</span> <span class="n">ds_surfaces_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;source_files&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">gifti_surfaces_wf</span><span class="p">,</span> <span class="n">ds_surfaces_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;outputnode.</span><span class="si">{</span><span class="n">surf</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;inputnode.</span><span class="si">{</span><span class="n">surf</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">surf</span> <span class="ow">in</span> <span class="n">surfs</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">ds_surfaces_wf</span><span class="p">,</span> <span class="n">surfaces_buffer</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;outputnode.</span><span class="si">{</span><span class="n">surf</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">surf</span><span class="p">)</span> <span class="k">for</span> <span class="n">surf</span> <span class="ow">in</span> <span class="n">surfs</span>
            <span class="p">]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">if</span> <span class="n">spheres</span><span class="p">:</span>
        <span class="n">gifti_spheres_wf</span> <span class="o">=</span> <span class="n">init_gifti_surfaces_wf</span><span class="p">(</span>
            <span class="n">surfaces</span><span class="o">=</span><span class="n">spheres</span><span class="p">,</span> <span class="n">to_scanner</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;gifti_spheres_wf&#39;</span>
        <span class="p">)</span>
        <span class="n">ds_spheres_wf</span> <span class="o">=</span> <span class="n">init_ds_surfaces_wf</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">surfaces</span><span class="o">=</span><span class="n">spheres</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ds_spheres_wf&#39;</span>
        <span class="p">)</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">surface_recon_wf</span><span class="p">,</span> <span class="n">gifti_spheres_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subject_id&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subjects_dir&#39;</span><span class="p">),</span>
                <span class="c1"># No transform for spheres, following HCP pipelines&#39; lead</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">sourcefile_buffer</span><span class="p">,</span> <span class="n">ds_spheres_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;source_files&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">gifti_spheres_wf</span><span class="p">,</span> <span class="n">ds_spheres_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;outputnode.</span><span class="si">{</span><span class="n">sphere</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;inputnode.</span><span class="si">{</span><span class="n">sphere</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sphere</span> <span class="ow">in</span> <span class="n">spheres</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">ds_spheres_wf</span><span class="p">,</span> <span class="n">surfaces_buffer</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;outputnode.</span><span class="si">{</span><span class="n">sphere</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sphere</span><span class="p">)</span> <span class="k">for</span> <span class="n">sphere</span> <span class="ow">in</span> <span class="n">spheres</span>
            <span class="p">]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">needed_metrics</span> <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">found_surfs</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ANAT Stage 8: Creating GIFTI metrics for </span><span class="si">{</span><span class="n">metrics</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">gifti_morph_wf</span> <span class="o">=</span> <span class="n">init_gifti_morphometrics_wf</span><span class="p">(</span><span class="n">morphometrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>
        <span class="n">ds_morph_wf</span> <span class="o">=</span> <span class="n">init_ds_surface_metrics_wf</span><span class="p">(</span>
            <span class="n">bids_root</span><span class="o">=</span><span class="n">bids_root</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ds_morph_wf&#39;</span>
        <span class="p">)</span>

        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">surface_recon_wf</span><span class="p">,</span> <span class="n">gifti_morph_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subject_id&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.subjects_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.subjects_dir&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">sourcefile_buffer</span><span class="p">,</span> <span class="n">ds_morph_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;source_files&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">gifti_morph_wf</span><span class="p">,</span> <span class="n">ds_morph_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;outputnode.</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;inputnode.</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">ds_morph_wf</span><span class="p">,</span> <span class="n">surfaces_buffer</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;outputnode.</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span>
            <span class="p">]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="k">if</span> <span class="s1">&#39;anat_ribbon&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">precomputed</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 8a: Creating cortical ribbon mask&#39;</span><span class="p">)</span>
        <span class="n">anat_ribbon_wf</span> <span class="o">=</span> <span class="n">init_anat_ribbon_wf</span><span class="p">()</span>
        <span class="n">ds_ribbon_mask_wf</span> <span class="o">=</span> <span class="n">init_ds_mask_wf</span><span class="p">(</span>
            <span class="n">bids_root</span><span class="o">=</span><span class="n">bids_root</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="n">mask_type</span><span class="o">=</span><span class="s1">&#39;ribbon&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ds_ribbon_mask_wf&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">t1w_buffer</span><span class="p">,</span> <span class="n">anat_ribbon_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;t1w_preproc&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.ref_file&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">surfaces_buffer</span><span class="p">,</span> <span class="n">anat_ribbon_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.white&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;pial&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.pial&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">sourcefile_buffer</span><span class="p">,</span> <span class="n">ds_ribbon_mask_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;source_files&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">anat_ribbon_wf</span><span class="p">,</span> <span class="n">ds_ribbon_mask_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.anat_ribbon&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.mask_file&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">ds_ribbon_mask_wf</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.mask_file&#39;</span><span class="p">,</span> <span class="s1">&#39;anat_ribbon&#39;</span><span class="p">)]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 8a: Found pre-computed cortical ribbon mask&#39;</span><span class="p">)</span>
        <span class="n">outputnode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">anat_ribbon</span> <span class="o">=</span> <span class="n">precomputed</span><span class="p">[</span><span class="s1">&#39;anat_ribbon&#39;</span><span class="p">]</span>

    <span class="c1"># Stage 9: Baseline fsLR registration</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">precomputed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 9: Creating fsLR registration sphere&#39;</span><span class="p">)</span>
        <span class="n">fsLR_reg_wf</span> <span class="o">=</span> <span class="n">init_fsLR_reg_wf</span><span class="p">()</span>
        <span class="n">ds_fsLR_reg_wf</span> <span class="o">=</span> <span class="n">init_ds_surfaces_wf</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="n">surfaces</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ds_fsLR_reg_wf&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">surfaces_buffer</span><span class="p">,</span> <span class="n">fsLR_reg_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;sphere_reg&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.sphere_reg&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">sourcefile_buffer</span><span class="p">,</span> <span class="n">ds_fsLR_reg_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;source_files&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">fsLR_reg_wf</span><span class="p">,</span> <span class="n">ds_fsLR_reg_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.sphere_reg_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.sphere_reg_fsLR&#39;</span><span class="p">)</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">ds_fsLR_reg_wf</span><span class="p">,</span> <span class="n">fsLR_buffer</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.sphere_reg_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">)]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 9: Found pre-computed fsLR registration sphere&#39;</span><span class="p">)</span>
        <span class="n">fsLR_buffer</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">sphere_reg_fsLR</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">precomputed</span><span class="p">[</span><span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">])</span>

    <span class="c1"># Stage 10: MSMSulc</span>
    <span class="k">if</span> <span class="n">msm_sulc</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">precomputed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sphere_reg_msm&#39;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 10: Creating MSM-Sulc registration sphere&#39;</span><span class="p">)</span>
        <span class="n">msm_sulc_wf</span> <span class="o">=</span> <span class="n">init_msm_sulc_wf</span><span class="p">(</span><span class="n">sloppy</span><span class="o">=</span><span class="n">sloppy</span><span class="p">)</span>
        <span class="n">ds_msmsulc_wf</span> <span class="o">=</span> <span class="n">init_ds_surfaces_wf</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="n">surfaces</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sphere_reg_msm&#39;</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ds_msmsulc_wf&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">surfaces_buffer</span><span class="p">,</span> <span class="n">msm_sulc_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;sulc&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.sulc&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;sphere&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.sphere&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">fsLR_buffer</span><span class="p">,</span> <span class="n">msm_sulc_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;sphere_reg_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.sphere_reg_fsLR&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">sourcefile_buffer</span><span class="p">,</span> <span class="n">ds_msmsulc_wf</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;source_files&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">msm_sulc_wf</span><span class="p">,</span> <span class="n">ds_msmsulc_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.sphere_reg_fsLR&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.sphere_reg_msm&#39;</span><span class="p">)</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">ds_msmsulc_wf</span><span class="p">,</span> <span class="n">msm_buffer</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.sphere_reg_msm&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_reg_msm&#39;</span><span class="p">)]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">elif</span> <span class="n">msm_sulc</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 10: Found pre-computed MSM-Sulc registration sphere&#39;</span><span class="p">)</span>
        <span class="n">msm_buffer</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">sphere_reg_msm</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">precomputed</span><span class="p">[</span><span class="s1">&#39;sphere_reg_msm&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 10: MSM-Sulc disabled&#39;</span><span class="p">)</span>

    <span class="c1"># Stage 11: Cortical surface mask</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">precomputed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cortex_mask&#39;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 11: Creating cortical surface mask&#39;</span><span class="p">)</span>

        <span class="n">cortex_masks_wf</span> <span class="o">=</span> <span class="n">init_cortex_masks_wf</span><span class="p">()</span>
        <span class="n">ds_cortex_masks_wf</span> <span class="o">=</span> <span class="n">init_ds_surface_masks_wf</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="n">mask_type</span><span class="o">=</span><span class="s1">&#39;cortex&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ds_cortex_masks_wf&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">surfaces_buffer</span><span class="p">,</span> <span class="n">cortex_masks_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;midthickness&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.midthickness&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.thickness&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">cortex_masks_wf</span><span class="p">,</span> <span class="n">ds_cortex_masks_wf</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.cortex_masks&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.mask_files&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outputnode.source_files&#39;</span><span class="p">,</span> <span class="s1">&#39;inputnode.source_files&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="n">ds_cortex_masks_wf</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outputnode.mask_files&#39;</span><span class="p">,</span> <span class="s1">&#39;cortex_mask&#39;</span><span class="p">)]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANAT Stage 11: Found pre-computed cortical surface mask&#39;</span><span class="p">)</span>
        <span class="n">outputnode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">cortex_mask</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">precomputed</span><span class="p">[</span><span class="s1">&#39;cortex_mask&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">workflow</span></div>



<div class="viewcode-block" id="init_anat_template_wf">
<a class="viewcode-back" href="../../../api/smriprep.workflows.anatomical.html#smriprep.workflows.anatomical.init_anat_template_wf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">init_anat_template_wf</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">longitudinal</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">omp_nthreads</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">num_files</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">image_type</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;T2w&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;anat_template_wf&#39;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a canonically-oriented, structural average from all input images.</span>

<span class="sd">    Workflow Graph</span>
<span class="sd">        .. workflow::</span>
<span class="sd">            :graph2use: orig</span>
<span class="sd">            :simple_form: yes</span>

<span class="sd">            from smriprep.workflows.anatomical import init_anat_template_wf</span>
<span class="sd">            wf = init_anat_template_wf(</span>
<span class="sd">                longitudinal=False, omp_nthreads=1, num_files=1, image_type=&quot;T1w&quot;</span>
<span class="sd">            )</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    longitudinal : :obj:`bool`</span>
<span class="sd">        Create unbiased structural average, regardless of number of inputs</span>
<span class="sd">        (may increase runtime)</span>
<span class="sd">    omp_nthreads : :obj:`int`</span>
<span class="sd">        Maximum number of threads an individual process may use</span>
<span class="sd">    num_files : :obj:`int`</span>
<span class="sd">        Number of images</span>
<span class="sd">    image_type : :obj:`str`</span>
<span class="sd">       MR image type (T1w, T2w, etc.)</span>
<span class="sd">    name : :obj:`str`, optional</span>
<span class="sd">        Workflow name (default: anat_template_wf)</span>

<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    anat_files</span>
<span class="sd">        List of structural images</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    anat_ref</span>
<span class="sd">        Structural reference averaging input images</span>
<span class="sd">    anat_valid_list</span>
<span class="sd">        List of structural images accepted for combination</span>
<span class="sd">    anat_realign_xfm</span>
<span class="sd">        List of affine transforms to realign input images to final reference</span>
<span class="sd">    out_report</span>
<span class="sd">        Conformation report</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">num_files</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fs_ver</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">Info</span><span class="p">()</span><span class="o">.</span><span class="n">looseversion</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;(version unknown)&#39;</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">__desc__</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">An anatomical </span><span class="si">{</span><span class="n">image_type</span><span class="si">}</span><span class="s2">-reference map was computed after registration of</span>
<span class="si">{</span><span class="n">num_files</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2"> images (after INU-correction) using</span>
<span class="s2">`mri_robust_template` [FreeSurfer </span><span class="si">{</span><span class="n">fs_ver</span><span class="si">}</span><span class="s2">, @fs_template].</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;anat_files&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">)</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;anat_ref&#39;</span><span class="p">,</span> <span class="s1">&#39;anat_valid_list&#39;</span><span class="p">,</span> <span class="s1">&#39;anat_realign_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;out_report&#39;</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 0. Denoise and reorient T1w image(s) to RAS and resample to common voxel space</span>
    <span class="n">anat_ref_dimensions</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">TemplateDimensions</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_ref_dimensions&#39;</span><span class="p">)</span>
    <span class="n">denoise</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">DenoiseImage</span><span class="p">(</span><span class="n">noise_model</span><span class="o">=</span><span class="s1">&#39;Rician&#39;</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">omp_nthreads</span><span class="p">),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="s1">&#39;input_image&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;denoise&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">anat_conform</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">Conform</span><span class="p">(),</span> <span class="n">iterfield</span><span class="o">=</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_conform&#39;</span><span class="p">)</span>

    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">anat_ref_dimensions</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;anat_files&#39;</span><span class="p">,</span> <span class="s1">&#39;anat_list&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">anat_ref_dimensions</span><span class="p">,</span> <span class="n">denoise</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;anat_valid_list&#39;</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">anat_ref_dimensions</span><span class="p">,</span> <span class="n">anat_conform</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;target_zooms&#39;</span><span class="p">,</span> <span class="s1">&#39;target_zooms&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;target_shape&#39;</span><span class="p">,</span> <span class="s1">&#39;target_shape&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="p">(</span><span class="n">denoise</span><span class="p">,</span> <span class="n">anat_conform</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;output_image&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">anat_ref_dimensions</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;out_report&#39;</span><span class="p">,</span> <span class="s1">&#39;out_report&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;anat_valid_list&#39;</span><span class="p">,</span> <span class="s1">&#39;anat_valid_list&#39;</span><span class="p">),</span>
        <span class="p">]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>

    <span class="k">if</span> <span class="n">num_files</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">get1st</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Select</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;get1st&#39;</span><span class="p">)</span>
        <span class="n">outputnode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">anat_realign_xfm</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">smriprep</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;itkIdentityTransform.txt&#39;</span><span class="p">))]</span>

        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">anat_conform</span><span class="p">,</span> <span class="n">get1st</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;inlist&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">get1st</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;anat_ref&#39;</span><span class="p">)]),</span>
        <span class="p">])</span>  <span class="c1"># fmt:skip</span>
        <span class="k">return</span> <span class="n">workflow</span>

    <span class="n">anat_conform_xfm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">LTAConvert</span><span class="p">(</span><span class="n">in_lta</span><span class="o">=</span><span class="s1">&#39;identity.nofile&#39;</span><span class="p">,</span> <span class="n">out_lta</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;source_file&#39;</span><span class="p">,</span> <span class="s1">&#39;target_file&#39;</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_conform_xfm&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 1. Template (only if several T1w images)</span>
    <span class="c1"># 1a. Correct for bias field: the bias field is an additive factor</span>
    <span class="c1">#     in log-transformed intensity units. Therefore, it is not a linear</span>
    <span class="c1">#     combination of fields and N4 fails with merged images.</span>
    <span class="c1"># 1b. Align and merge if several T1w images are provided</span>
    <span class="n">n4_correct</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">N4BiasFieldCorrection</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">copy_header</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="s1">&#39;input_image&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;n4_correct&#39;</span><span class="p">,</span>
        <span class="n">n_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># n_procs=1 for reproducibility</span>
    <span class="c1"># StructuralReference is fs.RobustTemplate if &gt; 1 volume, copying otherwise</span>
    <span class="n">anat_merge</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">StructuralReference</span><span class="p">(</span>
            <span class="n">auto_detect_sensitivity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">initial_timepoint</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># For deterministic behavior</span>
            <span class="n">intensity_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 7-DOF (rigid + intensity)</span>
            <span class="n">subsample_threshold</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">fixed_timepoint</span><span class="o">=</span><span class="ow">not</span> <span class="n">longitudinal</span><span class="p">,</span>
            <span class="n">no_iteration</span><span class="o">=</span><span class="ow">not</span> <span class="n">longitudinal</span><span class="p">,</span>
            <span class="n">transform_outputs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">mem_gb</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num_files</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_merge&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 2. Reorient template to RAS, if needed (mri_robust_template may set to LIA)</span>
    <span class="n">anat_reorient</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">Reorient</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_reorient&#39;</span><span class="p">)</span>

    <span class="n">merge_xfm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;merge_xfm&#39;</span><span class="p">,</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in1&#39;</span><span class="p">,</span> <span class="s1">&#39;in2&#39;</span><span class="p">],</span>
        <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">concat_xfms</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
        <span class="n">ConcatenateXFMs</span><span class="p">(</span><span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;concat_xfms&#39;</span><span class="p">,</span>
        <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_xfms&#39;</span><span class="p">],</span>
        <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_threads</span><span class="p">(</span><span class="n">in_list</span><span class="p">,</span> <span class="n">maximum</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">in_list</span><span class="p">),</span> <span class="n">maximum</span><span class="p">)</span>

    <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">anat_ref_dimensions</span><span class="p">,</span> <span class="n">anat_conform_xfm</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;anat_valid_list&#39;</span><span class="p">,</span> <span class="s1">&#39;source_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">anat_conform</span><span class="p">,</span> <span class="n">anat_conform_xfm</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;target_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">anat_conform</span><span class="p">,</span> <span class="n">n4_correct</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">anat_conform</span><span class="p">,</span> <span class="n">anat_merge</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">((</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">_set_threads</span><span class="p">,</span> <span class="n">omp_nthreads</span><span class="p">),</span> <span class="s1">&#39;num_threads&#39;</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">add_suffix</span><span class="p">,</span> <span class="s1">&#39;_template&#39;</span><span class="p">),</span> <span class="s1">&#39;out_file&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">n4_correct</span><span class="p">,</span> <span class="n">anat_merge</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;output_image&#39;</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">anat_merge</span><span class="p">,</span> <span class="n">anat_reorient</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
        <span class="c1"># Combine orientation and template transforms</span>
        <span class="p">(</span><span class="n">anat_conform_xfm</span><span class="p">,</span> <span class="n">merge_xfm</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_lta&#39;</span><span class="p">,</span> <span class="s1">&#39;in1&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">anat_merge</span><span class="p">,</span> <span class="n">merge_xfm</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;transform_outputs&#39;</span><span class="p">,</span> <span class="s1">&#39;in2&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">merge_xfm</span><span class="p">,</span> <span class="n">concat_xfms</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;in_xfms&#39;</span><span class="p">)]),</span>
        <span class="c1"># Output</span>
        <span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;anat_ref&#39;</span><span class="p">)]),</span>
        <span class="p">(</span><span class="n">concat_xfms</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;anat_realign_xfm&#39;</span><span class="p">)]),</span>
    <span class="p">])</span>  <span class="c1"># fmt:skip</span>
    <span class="k">return</span> <span class="n">workflow</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_pop</span><span class="p">(</span><span class="n">inlist</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inlist</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">inlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">inlist</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_aseg_to_three</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map FreeSurfer&#39;s segmentation onto a brain (3-)tissue segmentation.</span>

<span class="sd">    This function generates an index of 255+0 labels and maps them into zero (bg),</span>
<span class="sd">    1 (GM), 2 (WM), or 3 (CSF). The new values are set according to BIDS-Derivatives.</span>
<span class="sd">    Then the index is populated (e.g., label 3 in the original segmentation maps to label</span>
<span class="sd">    1 in the output).</span>
<span class="sd">    The `aseg lookup table</span>
<span class="sd">    &lt;https://github.com/freesurfer/freesurfer/blob/2beb96c6099d96508246c14a24136863124566a3/distribution/ASegStatsLUT.txt&gt;`__</span>
<span class="sd">    is available in the FreeSurfer source.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

    <span class="c1"># Base struct</span>
    <span class="n">aseg_lut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="c1"># GM</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">26</span><span class="p">:</span><span class="mi">40</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">42</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">47</span><span class="p">:</span><span class="mi">73</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># CSF</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">14</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">43</span><span class="p">:</span><span class="mi">45</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">72</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="c1"># WM</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">46</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">60</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">77</span><span class="p">:</span><span class="mi">80</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">aseg_lut</span><span class="p">[</span><span class="mi">250</span><span class="p">:</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">aseg_lut</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_split_segments</span><span class="p">(</span><span class="n">in_file</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">nibabel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nb</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

    <span class="n">segimg</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">(</span><span class="n">segimg</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">segimg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">hdr</span><span class="o">.</span><span class="n">set_data_dtype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>

    <span class="n">out_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="s1">&#39;GM&#39;</span><span class="p">,</span> <span class="s1">&#39;WM&#39;</span><span class="p">,</span> <span class="s1">&#39;CSF&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">out_fname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;aseg_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_mask.nii.gz&#39;</span><span class="p">)</span>
        <span class="n">segimg</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="n">segimg</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">out_fname</span><span class="p">)</span>
        <span class="n">out_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_fname</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out_files</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_probseg_fast2bids</span><span class="p">(</span><span class="n">inlist</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reorder a list of probseg maps from FAST (CSF, WM, GM) to BIDS (GM, WM, CSF).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">inlist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">inlist</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">inlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_is_skull_stripped</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if T1w images are skull-stripped.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">nibabel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nb</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">dataobj</span>
    <span class="n">sidevals</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">sidevals</span> <span class="o">&lt;</span> <span class="mi">10</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Copyright 2019, Center for Reproducible Neuroscience, Stanford University.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: fix/tfselect-resless
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Tags</dt>
            <dd><a href="../../../../0.10.0/index.html">0.10.0</a></dd>
            <dd><a href="../../../../0.11.0/index.html">0.11.0</a></dd>
            <dd><a href="../../../../0.11.0rc0/index.html">0.11.0rc0</a></dd>
            <dd><a href="../../../../0.11.0rc1/index.html">0.11.0rc1</a></dd>
            <dd><a href="../../../../0.11.1/index.html">0.11.1</a></dd>
            <dd><a href="../../../../0.12.0/index.html">0.12.0</a></dd>
            <dd><a href="../../../../0.12.1/index.html">0.12.1</a></dd>
            <dd><a href="../../../../0.12.2/index.html">0.12.2</a></dd>
            <dd><a href="../../../../0.13.0/index.html">0.13.0</a></dd>
            <dd><a href="../../../../0.13.1/index.html">0.13.1</a></dd>
            <dd><a href="../../../../0.13.2/index.html">0.13.2</a></dd>
            <dd><a href="../../../../0.14.0/index.html">0.14.0</a></dd>
            <dd><a href="../../../../0.15.0/index.html">0.15.0</a></dd>
            <dd><a href="../../../../0.16.0/index.html">0.16.0</a></dd>
            <dd><a href="../../../../0.16.1/index.html">0.16.1</a></dd>
            <dd><a href="../../../../0.17.0/index.html">0.17.0</a></dd>
            <dd><a href="../../../../0.18.0/index.html">0.18.0</a></dd>
            <dd><a href="../../../../0.8.0/index.html">0.8.0</a></dd>
            <dd><a href="../../../../0.8.0rc1/index.html">0.8.0rc1</a></dd>
            <dd><a href="../../../../0.8.0rc2/index.html">0.8.0rc2</a></dd>
            <dd><a href="../../../../0.8.0rc3/index.html">0.8.0rc3</a></dd>
            <dd><a href="../../../../0.8.1/index.html">0.8.1</a></dd>
            <dd><a href="../../../../0.8.2/index.html">0.8.2</a></dd>
            <dd><a href="../../../../0.8.3/index.html">0.8.3</a></dd>
            <dd><a href="../../../../0.9.0/index.html">0.9.0</a></dd>
            <dd><a href="../../../../0.9.1/index.html">0.9.1</a></dd>
            <dd><a href="../../../../0.9.2/index.html">0.9.2</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../../dev-nibabies/index.html">dev-nibabies</a></dd>
            <dd><a href="../../../../enh_calabel/index.html">enh/calabel</a></dd>
            <dd><a href="../../../../enh_split-surfaces/index.html">enh/split-surfaces</a></dd>
            <dd><a href="../../../../fix_parcstats/index.html">fix/parcstats</a></dd>
            <dd><a href="../../../../fix_recon-report/index.html">fix/recon-report</a></dd>
            <dd><a href="anatomical.html">fix/tfselect-resless</a></dd>
            <dd><a href="../../../../maint_0.12.x/index.html">maint/0.12.x</a></dd>
            <dd><a href="../../../../maint_0.13.x/index.html">maint/0.13.x</a></dd>
            <dd><a href="../../../../maint_0.15.x/index.html">maint/0.15.x</a></dd>
            <dd><a href="../../../../maint_0.16.x/index.html">maint/0.16.x</a></dd>
            <dd><a href="../../../../maint_0.17.x/index.html">maint/0.17.x</a></dd>
            <dd><a href="../../../../maint_0.18.x/index.html">maint/0.18.x</a></dd>
            <dd><a href="../../../../maint_0.8.x/index.html">maint/0.8.x</a></dd>
            <dd><a href="../../../../maint_0.9.x/index.html">maint/0.9.x</a></dd>
            <dd><a href="../../../../master/index.html">master</a></dd>
            <dd><a href="../../../../rel_0.16.1/index.html">rel/0.16.1</a></dd>
            <dd><a href="../../../../rel_0.8.0rc1/index.html">rel/0.8.0rc1</a></dd>
        </dl>
    </div>
</div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>